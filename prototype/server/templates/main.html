<!DOCTYPE HTML>
<html>
<head>
	<title>Grid</title>
	<script type="text/javascript" src="resources/jquery.js"></script>

	<script type="text/javascript" src="resources/jquery.gridster.js"></script>
	<link rel="stylesheet" type="text/css" href="resources/jquery.gridster.css">

	<link href='http://fonts.googleapis.com/css?family=Unica+One' rel='stylesheet' type='text/css'>

	<script type="text/javascript">
		var phones, gridster, was_dragged;

		$.ajaxSetup ({
			cache: false
		});

		$(document).ready(function() {
			was_dragged = false;

			phones = {{.Phones}}

			$(".gridster > ul").width((140+20)*6);

			//Build gridster
			gridster = $(".gridster > ul").gridster({
				widget_margins: [10, 10],
				widget_base_dimensions: [140, 140],
				serialize_params: function($w, wgd) { return { content_id: $w.attr('content_id'), col: wgd.col, row: wgd.row, size_x: wgd.size_x, size_y: wgd.size_y } }
			}).data('gridster');

			gridster.cols = 6 //Can't figure out why I'm not getting 6 cols automatically but I'll just force it

			//Add all the widget without worrying about layout
			for(var i = 0;i < phones.length;i++) {
				var img = $(document.createElement('img')).attr('src', phones[i].filepath);
				var a = $(document.createElement('a')).append(img);
				a.attr('href', '#');
				var li = $(document.createElement('li')).append(a);
				li.attr('content_id', phones[i].content_id)
				gridster.add_widget(li, 1, 1);
			}

			getLayout()

			setInterval(getLayout, 2000);

			//Handle click in a useful way
			$(".gridster > ul > li > a").click(function(e) {
				e.preventDefault();
				if(was_dragged) {
					was_dragged = false;

					if(gridster.$changed != null && (gridster.$changed).length > 1) {
						pushLayout(gridster.serialize());
					}
				} else {
					if($(this).parent().css("border-width") == "0px") {
						$(this).parent().css("border", "3px solid red");
						// $("#output").text($(this).parent().css("padding"));
					} else {
						$(this).parent().css("border", "none");
					}
				}
			});

			//Track dragging
			$(".gridster > ul > li > a").mouseup(function(e) {
				if($(this).parent().hasClass("dragging")) {
					was_dragged = true;
				} else {
					was_dragged = false;
				}
			});
		});
		
		function pushLayout(widget_layout) {
			$.ajax({
				url: "http://localhost:8080/ajax/pushlayout",
				type: 'POST',
				data: JSON.stringify(widget_layout),
				processData: false, //Prevent the data from being transformed into a query string
				timeout: 4000,
				dataType: "json",
				contentType: 'application/json',
				success: function(data, status, err) { },
				error: function(xhr, status, err) { }
			});
		}

		function getLayout() {
			$.ajax({
				url: "http://localhost:8080/ajax/getlayout",
				type: 'POST',
				data: [],
				processData: false, //Prevent the data from being transformed into a query string
				timeout: 4000,
				dataType: "json",
				contentType: 'application/json',
				success: function(data, status, err) { if(data != null && !gridster.drag_api.is_dragging) { runLayout(data); } },
				error: function(xhr, status, err) { }
			});
		}

		function runLayout(widget_layout) {
			for(var i = 0;i < widget_layout.length;i++) {
				$w = $("[content_id='"+widget_layout[i].content_id+"']").first();
				gridster.remove_from_gridmap($w.coords().grid);
			}

			for(var i = 0;i < widget_layout.length;i++) {
				$w = $("[content_id='"+widget_layout[i].content_id+"']").first();

				if(!gridster.is_empty(widget_layout[i].col, widget_layout[i].row)) {
					gridster.empty_cells(widget_layout[i].col, widget_layout[i].row, 1, 1);
				}

				//Perform the move
				$w.attr({
					'data-col': widget_layout[i].col,
					'data-row': widget_layout[i].row
				});

				//Change the correct associated position inside the widget
				$w.coords().grid.col = widget_layout[i].col;
				$w.coords().grid.row = widget_layout[i].row;

				//Push it back into the internal mapping
				gridster.add_to_gridmap($w.coords().grid, $w);
			}

			for(var i = 0;i < widget_layout.length;i++) {
				$w = $("[content_id='"+widget_layout[i].content_id+"']").first();
				gridster.add_to_gridmap($w.coords().grid, $w);
			}

			//Recompute the CSS height of the container
			gridster.set_dom_grid_height();
			//Assuming we don't want to record the change since we caused it
			gridster.$changed = $([]);
		}
	</script>

	<style type="text/css">
		body {
			background-color: rgb(101, 120, 120);
			color: rgb(238, 238, 238);
			margin: 0px;
			text-align: center;
		}

		.gridster {
			background-color: rgb(255, 200, 80);
			text-align: center;
			margin: 25px auto 25px auto;
		}

		.gridster ul {
			list-style: none;
			margin: 0px auto 0px auto;
			padding: 0px;
		}

		.gridster ul li {
			background-color: rgb(101, 120, 120);
		}

		.gridster ul li img {
			max-width: 140px;
			max-height: 140px;
		}

		#output {
			margin: 20px auto 20px auto;
			width: 600px;
			background-color: rgb(101, 101, 101);
		}

		.event {
			font-family: 'Unica One', cursive;
			background-color: rgb(200, 200, 200);
			padding: 10px;
			max-width: 120px;
			margin: auto;
		}

		.event a:link {
			text-decoration: none;
			font-weight: bold;
			color: rgb(50, 50, 50);
		}

		.event a:hover {
			text-decoration: underline;
		}

		.event a:active, .event a:visited {
			color: rgb(50, 50, 50);
		}
	</style>
</head>
<body>
	<p id="output"></p>
	
<!-- 	<div class="event" id="serialize"><a href="#">Serialize</a></div>
	<div class="event" id="reorder"><a href="#">Reorder</a></div>
	<div class="event" id="json"><a href="#">JSON</a></div>

 -->	<div class="gridster">
		<ul>
		</ul>
	</div>
</body>
</html>