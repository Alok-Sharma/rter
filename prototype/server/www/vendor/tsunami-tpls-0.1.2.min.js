/**
 * Tsunami - The video addon for AngularJS
 * @version v0.1.2 - 2014-01-08
 * @link http://tsunamijs.github.com
 * @license Apache 2 License, http://opensource.org/licenses/Apache-2.0
 */
angular.module("tsunami.config",[]).value("tsunami.config",{}),angular.module("tsunami.templates",[]),angular.module("tsunami.filters",["tsunami.config"]),angular.module("tsunami.services",["tsunami.config"]),angular.module("tsunami.directives",["tsunami.config","tsunami.templates","tsunami.filters","tsunami.services"]),angular.module("tsunami",["tsunami.filters","tsunami.directives","tsunami.services","tsunami.templates","tsunami.config"]),angular.module("tsunami.filters").filter("timecode",function(){return function(e,t){var i=Math.floor(e/3600),n=Math.floor((e-3600*i)/60),r=Math.floor((e-3600*i)%60),s=1e3*(e-3600*i-60*n-r).toFixed(3);return(i>0?i+":":"")+(10>n?"0"+n:n)+":"+(10>r?"0"+r:r)+(t?"."+s:"")}}),angular.module("tsunami.directives").directive("liveThumbnail",["$timeout","$log",function(e,t){"use strict";var i="ontouchstart"in document.documentElement;return{restrict:"A",replace:!0,templateUrl:"template/livethumbnail.html",controller:"LiveThumbnailCtrl",link:function(n,r,s){function a(e){switch(I=e,e){case v.skimming:n.status="Skimming";break;case v.playing:switch(T){case b.live:n.status="Live";break;case b.eos:n.status="Playback"}break;case v.paused:switch(T){case b.live:n.status="Paused";break;case b.eos:n.status="Playback"}}}function o(e){T=e,a(I)}function u(){I=v.skimming,T=b.live,e.cancel(L),L=0,E=0,x=0,w=0,P=0,H=!1,D=!1,A="",M="",V=new Image,U=0,C=0,n.bgimageurl="",n.skimmerWidth=0,n.selected=!1,n.bgimageurl="",n.status=""}function l(e){if(void 0!==e){var t=n.c.video,i=n.selected;n.selected&&n.$emit("deselected",t),u();var r;r=s.liveThumbnail?n.$eval(s.liveThumbnail):{},angular.extend(n.c,r),A=n.c.video.thumbnailUrl.slice(0,n.c.video.thumbnailUrl.lastIndexOf("/")+1);var a,l,d=new Date,y=new Date(d.toUTCString()),v=y.getTime();void 0!==n.c.video.StartTime?n.c.debuglive?U=v:(a=new Date(n.c.video.StartTime),U=a.getTime()):U=v,void 0!==n.c.video.StopTime?n.c.debuglive?(a=new Date(n.c.video.StopTime),l=new Date(n.c.video.StartTime),C=a.getTime()-l.getTime()+U):(a=new Date(n.c.video.StopTime),C=a.getTime()):C=0,n.c.debuglive?o(b.live):o(C>U?b.eos:b.live),x=0===C||n.c.debuglive?~~((y-U)/1e3):~~((C-U)/1e3),n.selected=n.c.selectable&&i,M=m(x,0),f(M,function(){n.bgimageurl=V.src,n.$apply()},function(){n.failedCount++,n.$apply()}),n.c.autoplay?h():n.c.skimmable?c():g(),D||p()}}function d(){n.c.selectable&&(n.selected?n.selected=!1:n.isSkimming()||(n.selected=!0),n.selected?n.$emit("selected",n.c.video):n.$emit("deselected",n.c.video))}function h(){T===b.eos?n.$emit("eos",n.c.video):n.$emit("playing",n.c.video),a(v.playing),""!==M?n.bgimageurl=M:y()}function c(){a(v.skimming),n.$emit("skimming",n.c.video)}function g(){T!==b.eos&&(a(v.paused),n.$emit("paused",n.c.video))}function p(){return n.isEOS()?(D=!1,void 0):(D=!0,L=e(function(){y(),p()},1e3*n.c.interval),void 0)}function m(e,t){var i=e>0?e:0,r=t>0?t:0;return A+("000000000"+~~(i*r/n.c.interval+1)).substr(-9)+".jpg"}function f(e,t,i){V=new Image,V.onload=t,V.onerror=i,V.src=e}function y(){H&&(t.info("LiveThumb: slow server, cancelling download"),V.src=""),H=!0;var e=new Date,i=new Date(e.toUTCString()),r=i.getTime();if(C>0&&r>=C)return o(b.eos),n.$emit("eos",n.c.video),void 0;x=~~((r-U)/1e3)-w;var s=m(x,1);new Date(U),f(s,function(){H=!1,P=0,n.isSkimming()||n.isPaused()||(n.bgimageurl=V.src),M=V.src},function(){H=!1,P++,w+=n.c.interval,x-=n.c.interval}),P>5&&(C=U+x-w,o(b.eos),n.$emit("eos",n.c.video))}var v={playing:0,skimming:1,paused:2},b={live:0,eos:1};n.c={showtitle:!1,showstate:!0,autoplay:!0,selectable:!1,skimmable:!0,clickable:!1,interval:2,width:160,height:90,debuglive:!1,video:{}};var S=angular.element(r.children()[1]),k=angular.element(S.children()[0]),I=v.skimming,T=b.live,L=0,E=0,x=0,w=0,P=0,H=!1,D=!1,A="",M="",V=new Image,U=0,C=0;n.skimmerWidth=0,n.selected=!1,n.bgimageurl="",n.status="",n.isPlaying=function(){return I===v.playing},n.isSkimming=function(){return I===v.skimming},n.isPaused=function(){return I===v.paused},n.isLive=function(){return T===b.live},n.isEOS=function(){return T===b.eos},l(),n.$watch(s.liveThumbnail,l,!0),n.mouseClicked=function(){n.c.clickable&&n.$emit("clicked",n.c.video),d(),n.c.clickable&&(n.c.skimmable?n.isSkimming()?h():c():n.isPaused()?h():g())},n.skipTo=function(e){if(n.c.skimmable&&n.isSkimming()){var t=k.width(),r=0;r=angular.isDefined(e.offsetX)?e.offsetX:(i?e.originalEvent.targetTouches[0].clientX:e.clientX)-k.offset().left,E=Math.max(0,Math.min(r,t)),n.skimmerWidth=(100*(E/t)).toFixed(1),f(m(x,E/t),function(){n.bgimageurl=V.src,n.$apply()},function(){x-=n.c.interval,w+=n.c.interval,n.$apply()})}},n.$on("$destroy",function(){e.cancel(L)})}}}]).controller("LiveThumbnailCtrl",["$scope","$log",function(){}]),angular.module("tsunami.directives").directive("storyPlayer",["tsunami.config","$timeout","$log","$document","$compile","$controller","$injector",function(e,t,i,n,r,s,a){var o={theme:"simple",showTitle:!1,enableTrimmer:!1,enableFullscreen:!1,fullscreenMode:"window",enableStashing:!0,showVolume:!0,showThumbnails:!1,autoplay:!0,autohide:!0,width:640,height:360,story:null,editlist:null,engine:"HLSVideo"},u=e.storyplayer||{},l=angular.extend({},o,u),d={IDLE:0,PAUSED:1,PLAYING:2,SEEKING:3,EOS:4,FAILED:5},h={IDLE:0,LOADING:1,SEEKING:2,PLAYING:3,PAUSED:4,EOS:7,FAILED:8},c={NOOP:0,LOAD:1,SEEK:2,PLAY:3,PAUSE:4,INTRANS:5,OUTTRANS:6};return{restrict:"A",replace:!0,templateUrl:"template/storyplayer.html",link:function(e,n,r){function s(){0===e.tracks.length&&angular.forEach(e.trackIds,function(){e.tracks.push({videoElement:null,engine:null,state:h.IDLE,wasPlaying:!1,footage_id:0,buffered:0,anim_style:"",ltmask_style:"",rbmask_style:"",engine_style:""})}),angular.forEach(n.children(),function(t,i){if(!(e.isError||i>e.tracks.length-1||null!==e.tracks[i].videoElement)){var n={trackId:i},r=angular.element(angular.element(t).children()[0]).children()[0],s=a.get(l.engine+"Engine").getInstance();return angular.element(r).is("video")&&s.isSupported()?(s.init(r,e,n),e.tracks[i].videoElement=r,e.tracks[i].engine=s,void 0):(e.errorMsg="Error: "+e.c.engine+" Engine unsupported on this browser.",e.isError=!0,e.tracks.length=0,e.playState=d.FAILED,void 0)}}),e.isError||(i.info("Story: created "+e.tracks.length+" engines."),console.log(e.tracks),e.$on("timeupdate",e.timeUpdateHandler),e.$on("bufferupdate",e.bufferUpdateHandler),e.$on("playing",e.engineHandler),e.$on("paused",e.engineHandler),e.$on("seeked",e.engineHandler),e.$on("loaded",e.engineHandler),e.$on("eos",e.engineHandler),e.$on("error",e.engineErrorHandler))}function o(){var t;t=r.storyPlayer?e.$eval(r.storyPlayer):{},e.c=angular.extend({},l,t),null!==e.c.editlist&&null!==e.c.story&&(u(),g())}function u(){e.playerWidth=e.c.width||l.width,e.playerHeight=e.c.height||l.height;for(var t=e.tracks.length,i=0;t>i;i++)e.tracks[i].engine.setWidth(e.playerWidth),e.tracks[i].engine.setHeight(e.playerHeight)}function g(){e.schedule.length=0;for(var t=[],i=0,n=e.trackIds.length,r=0;n>r;r++)t.push({loadedFootage:0});for(n=e.c.editlist.length,r=0;n>r;r++){var s=e.c.editlist[r],a=s.track_id;i=Math.max(i,s.start+s.duration);var o={itemId:r,track:a,time:0,type:c.NOOP};s.footage.id!==t[a].loadedFootage&&(o.type=c.LOAD,o.time=s.start,e.schedule.push(angular.copy(o)),t[a].loadedFootage=s.footage.id),o.type=c.SEEK,o.time=s.start+f-y,e.schedule.push(angular.copy(o)),o.type=c.PLAY,o.time=s.start+f,e.schedule.push(angular.copy(o)),o.type=c.PAUSE,o.time=s.start+f+s.duration,e.schedule.push(angular.copy(o)),o.type=c.INTRANS,o.time=s.start+f,e.schedule.push(angular.copy(o)),o.type=c.OUTTRANS,o.time=s.start+f+s.duration-s.out_effect.duration,e.schedule.push(angular.copy(o))}e.duration=i,e.schedule.sort(function(e,t){var i=e.time,n=t.time;return n>i?-1:i>n?1:0})}function p(t,n){e.tracks[n].ltmask_style={left:""+100*t.box.left+"%",top:""+100*t.box.top+"%"},e.tracks[n].rbmask_style={left:""+100*(t.crop.width-1)+"% ",top:""+100*(t.crop.height-1)+"% "},e.tracks[n].engine_style={left:""+100*t.crop.left+"% ",top:""+100*t.crop.top+"% "},i.info("CROP ---->"),console.log(e.tracks[n]),console.log(t)}function m(){var n=e.schedule[e.nextActionId],r=e.c.editlist[n.itemId],s=(new Date).getTime();switch(s-e.playbackStartTime,i.info("Story scheduling at idx="+e.nextActionId+" time="+e.currentTime+" dur="+e.duration+" start="+e.playbackStartTime+" now="+s),console.log(n),console.log(r),n.type){case c.NOOP:break;case c.LOAD:e.tracks[n.track].engine.setSourceUrl(r.footage.url)&&(e.tracks[n.track].state=h.LOADING,e.tracks[n.track].buffered=0,e.tracks[n.track].wasPlaying=!1,e.tracks[n.track].footage_id=r.footage.id,e.tracks[n.track].engine.load());break;case c.SEEK:e.tracks[n.track].state=h.SEEKING,e.tracks[n.track].engine.setCurrentTime(r.offset);break;case c.PLAY:p(r,n.track),e.tracks[n.track].engine.play();break;case c.PAUSE:e.tracks[n.track].engine.pause();break;case c.INTRANS:p(r,n.track),e.tracks[n.track].anim_style={animationTimingFunction:r.in_effect.slope,animationName:r.in_effect.type,animationDuration:(r.in_effect.duration/1e3).toFixed(5)};break;case c.OUTTRANS:p(r,n.track),e.tracks[n.track].anim_style={animationTimingFunction:r.out_effect.slope,animationName:r.out_effect.type,animationDuration:(r.out_effect.duration/1e3).toFixed(5)}}if(e.nextActionId<e.schedule.length-1){e.nextActionId++;var a=e.schedule[e.nextActionId].time;a-=(new Date).getTime()-e.playbackStartTime,e.scheduleTimeout=t(m,a>0?a:0)}else e.playState=d.EOS}var f=2e3,y=100;e.tracks=[],e.schedule=[],e.nextActionId=0,e.playState=d.IDLE,e.playbackStartTime=0,e.trackIds=[0,1,2],e.c=l,e.isError=!1,e.errorMsg="",e.buffered=0,e.played=0,e.currentTime=0,e.duration=0,e.playerWidth=l.width,e.playerHeight=l.height,e.isMouseOver=!1,e.isFullwindow=!1,e.isFullscreen=!1,e.showTrimmer=!1,e.stashable=!0,e.toggleFullscreen=function(){},e.toggleTrimmer=function(){},e.stash=function(){e.$emit("stashed",story,editlist)},e.engineHandler=function(t,n){var r=n.trackId;if(i.info("Story: captured event "+t.name+" from engine "+r),!(r>e.tracks.length-1)){switch(t.name){case"playing":e.tracks[r].state=h.PLAYING;break;case"paused":e.tracks[r].state=h.PAUSED;break;case"seeked":e.tracks[r].state=e.tracks[r].wasPlaying?h.PLAYING:h.PAUSED,e.tracks[r].wasPlaying=!1;break;case"loaded":e.tracks[r].state=h.PAUSED;break;case"eos":e.tracks[r].state=h.EOS}t.stopPropagation()}},e.engineErrorHandler=function(t,n,r,s){var a=n.trackId;i.error("Story: captured error event for engine "+a),a>e.tracks.length-1||(e.tracks[a].state=h.FAILED,e.tracks[a].wasPlaying=!1,t.stopPropagation(),e.pause(),e.errorMsg="Error: "+s+" on track "+a,e.isError=!0)},e.timeUpdateHandler=function(t,i){i.trackId,e.playState===d.PLAYING&&(e.currentTime=(new Date).getTime()-e.playbackStartTime);var n=e.duration>0?e.currentTime/e.duration:0;e.played=(100*n).toFixed(1),angular.isFunction(t.stopPropagation)&&t.stopPropagation()},e.bufferUpdateHandler=function(t,n,r,s){var a=n.trackId;e.tracks[a].buffered=s-r;for(var o=e.duration,u=e.tracks.length,l=0;u>l;l++)maxBuffered=Math.min(o,e.tracks[l].buffered);var d=e.duration>0?o/e.duration:0;e.buffered=(100*d).toFixed(1),i.info("Story buffered: "+e.buffered)},e.playpause=function(){switch(e.playState){case d.IDLE:e.play();break;case d.PAUSED:e.play();break;case d.PLAYING:e.pause();break;case d.SEEKING:e.pause();break;case d.EOS:e.seekTo(0),e.play();break;case d.FAILED:}},e.isLoading=function(){return!1},e.isBuffering=function(){return!1},e.isPaused=function(){return e.playState===d.PAUSED},e.isPlaying=function(){return e.playState===d.PLAYING},e.play=function(){for(var t=e.tracks.length,n=0;t>n;n++)e.tracks[n].wasPlaying&&(e.tracks[n].wasPlaying=!1,e.tracks[n].engine.play());e.playState=d.PLAYING,e.playbackStartTime=(new Date).getTime()-e.currentTime,i.info("Story play(): curr:"+e.currentTime+" start="+e.playbackStartTime),m()},e.pause=function(){e.currentTime=(new Date).getTime()-e.playbackStartTime,e.playState=d.PAUSED,i.info("Story pause(): curr:"+e.currentTime+" start="+e.playbackStartTime),t.cancel(e.scheduleTimeout),e.scheduleTimeout=0;for(var n=e.tracks.length,r=0;n>r;r++)e.tracks[r].state===h.PLAYING&&(e.tracks[r].wasPlaying=!0,e.tracks[r].engine.pause())},e.showTrack=function(t){if(t>e.tracks.length-1)return!1;var i=e.tracks[t].state;return i===h.PLAYING||i===h.INTRANS||i===h.OUTTRANS},e.getStoryStyle=function(){var t={width:e.playerWidth,height:e.playerHeight};return e.playState!==d.IDLE&&e.playState!==d.EOS||!e.c.story?t.background="#000":t.backgroundImage="url("+e.c.story.poster+")",t},e.getAnimStyle=function(t){return 0===e.tracks.length||t>e.tracks.length-1?"":e.tracks[t].anim_style},e.getLTMaskStyle=function(t){return 0===e.tracks.length||t>e.tracks.length-1?"":e.tracks[t].ltmask_style},e.getRBMaskStyle=function(t){return 0===e.tracks.length||t>e.tracks.length-1?"":e.tracks[t].rbmask_style},e.getEngineStyle=function(t){return 0===e.tracks.length||t>e.tracks.length-1?"":e.tracks[t].engine_style},e.seek=function(){},e.$watch(r.storyPlayer,o,!0),t(s)}}}]).controller("StoryPlayerController",["$scope",function(){}]),angular.module("tsunami.directives").directive("trimmer",["tsunami.config","$log","$document","$window","$compile","$timeout",function(e,t,i,n,r,s){"use strict";var a={showTitle:!1,showPlayhead:!1,thumbSource:"grid",thumbUrl:"",thumbWidth:160,thumbHeight:90,thumbGridx:8,thumbGridy:10,videoId:0,videoTitle:"",videoDuration:1/0,trimIn:0,trimOut:1},o=e.trimmer||{},u=angular.extend({},a,o),l="ontouchstart"in document.documentElement;return{restrict:"A",replace:!0,scope:{config:"&"},templateUrl:"template/trimmer.html",link:function(e,t,r){function a(){e.isError=!1,e.errorMsg="",e.gridRescaleBGx=0,e.gridRescaleBGy=0,e.thumbWidth=0,e.thumbHeight=0,e.leftMarker=u.trimIn,e.rightMarker=u.trimOut,e.c=angular.extend({},u,e.config()),e.leftMarker=e.c.trimIn/e.c.videoDuration,e.rightMarker=e.c.trimOut/e.c.videoDuration,o()}function o(){var t=e.trimline.height(),i=e.c.thumbHeight/t;"grid"===e.c.thumbSource&&(e.thumbWidth=(e.c.thumbWidth/i).toFixed(0),e.thumbHeight=(e.c.thumbHeight/i).toFixed(0),e.gridRescaleBGx=e.thumbWidth*e.c.thumbGridx,e.gridRescaleBGy=e.thumbHeight*e.c.thumbGridy);var n=e.trimline.width(),r=Math.ceil(n/e.thumbWidth+2);e.thumbs.length=0;for(var s=0;r>s;++s)e.thumbs.push(s)}function d(n){return e.isSelected||(e.isSelected=!0,e.$emit("selected",e.c.videoId)),e.currentHandle=n.data.handle,0===e.trimline.offset().left+e.trimline.width()*e.currentHandle?e.leftMarker:e.rightMarker,l?(t.bind("touchmove",c),i.bind("touchend",h)):(t.bind("mousemove",c),i.bind("mouseup",h)),e.$emit("seek",e.c.videoId,(0===e.currentHandle?e.leftMarker:e.rightMarker)*e.c.videoDuration),e.$apply(),n.preventDefault(),n.stopPropagation(),!1}function h(n){return t.unbind(l?"touchmove":"mousemove",c),i.unbind(l?"touchend":"mouseup",h),e.$emit("trimmed",e.c.videoId,e.leftMarker*e.c.videoDuration,e.rightMarker*e.c.videoDuration),e.$apply(),n.preventDefault(),n.stopPropagation(),!1}function c(t){var i=(l?t.originalEvent.targetTouches[0].clientX:t.clientX)-e.trimline.offset().left,n=i/e.trimline.width();return i>=0&&e.trimline.width()>=i&&e.trimTo(n,e.currentHandle),e.$apply(),t.preventDefault(),t.stopPropagation(),!1}e.c=angular.copy(u),e.isError=!1,e.errorMsg="",e.gridRescaleBGx=0,e.gridRescaleBGy=0,e.thumbWidth=0,e.thumbHeight=0,e.currentHandle=0,e.isSelected=!1,e.wasClicked=!1,e.dblclickTimeoutId=0,e.leftMarker=u.trimIn,e.rightMarker=u.trimOut,e.leftSaved=0,e.rightSaved=1,e.thumbs=[],e.trimline=angular.element(t.children()[0]),e.trimnails=angular.element(e.trimline.children()[0]),e.leftHandle=angular.element(e.trimline.children()[3]).children()[0],e.rightHandle=angular.element(e.trimline.children()[3]).children()[1],angular.element(e.leftHandle).bind(l?"touchstart":"mousedown",{handle:0},d),angular.element(e.rightHandle).bind(l?"touchstart":"mousedown",{handle:1},d),r.$observe("config",a),angular.element(n).bind("resize",o),e.$watch(function(){return e.trimline.width()},function(e,t){e!=t&&o()}),e.$on("deselect",function(t,i){i!==e.c.videoId&&e.isSelected&&(e.isSelected=!1,e.$emit("deselected",e.c.videoId))}),e.trimTo=function(t){var i=!1;if(0===e.currentHandle){if(t>e.rightMarker)return;i=e.leftMarker!==t.toFixed(5),e.leftMarker=t.toFixed(5)}else if(1===e.currentHandle){if(e.leftMarker>t)return;i=e.rightMarker!==t.toFixed(5),e.rightMarker=t.toFixed(5)}i&&(e.leftSaved=0,e.rightSaved=1,e.$emit("seek",e.c.videoId,t.toFixed(5)*e.c.videoDuration))},e.makeThumbStyle=function(t,i){var n=Math.ceil(t*e.c.thumbGridx*e.c.thumbGridy/i),r=n%e.c.thumbGridx,s=0|n/e.c.thumbGridx,a=""+r*-e.thumbWidth+"px "+(""+s*-e.thumbHeight)+"px",o={width:e.thumbWidth,height:e.thumbHeight,backgroundPosition:a,backgroundSize:e.gridRescaleBGx+"px "+e.gridRescaleBGy+"px"};return""!==e.c.thumbUrl&&(o.backgroundImage="url("+e.c.thumbUrl+")"),o},e.resetTrim=function(){0===e.leftSaved&&1===e.rightSaved?(e.leftSaved=e.leftMarker,e.rightSaved=e.rightMarker,e.leftMarker=0,e.rightMarker=1):(e.leftMarker=e.leftSaved,e.rightMarker=e.rightSaved,e.leftSaved=0,e.rightSaved=1),e.$emit("trimmed",e.c.videoId,e.leftMarker*e.c.videoDuration,e.rightMarker*e.c.videoDuration)},e.eatClick=function(t){return e.wasClicked?(s.cancel(e.dblclickTimeoutId),e.wasClicked=!1,e.dblclickTimeoutId=0,e.resetTrim()):(e.wasClicked=!0,e.dblclickTimeoutId=s(function(){e.wasClicked=!1},500)),e.isSelected||(e.isSelected=!0,e.$emit("selected",e.c.videoId)),t.preventDefault(),t.stopPropagation(),!1}}}}]).controller("TrimmerCtrl",["$scope","$element","$attrs","$log",function(e,t,i,n){n.info("Constructing TrimmerCtrl Controller")}]),angular.module("tsunami.directives").controller("DASHVideoController",["$scope","$log","sound",function(e,t,i){function n(){x=!1}function r(){f()}function s(){x=!1,f(),e.$emit("loaded",e.c.video,e.getCurrentTime())}function a(){e.$apply(function(){e.setPlayhead()})}function o(){}function u(){w=!0,H=!0,e.$emit("eos",e.c.video,e.getCurrentTime())}function l(){E("Error"),t.info(A.error)}function d(){}function h(){if(A.readyState>=1){if(D=A.currentSrc,0===e.c.width||0===e.c.height){var t=e.getVideoWidth(),i=e.getVideoHeight(),n=i/t;e.setWidth(e.c.width||e.c.height/n||t),e.setHeight(e.c.height||e.c.width*n||i)}P=!0,f()}}function c(){x=!0}function g(){}function p(){e.$emit("playing",e.c.video,e.getCurrentTime())}function m(){e.$emit("paused",e.c.video,e.getCurrentTime())}function f(){e.$apply(function(){e.updateProgress()})}function y(){}function v(){w=!1,e.$emit("seeked",e.c.video,e.getCurrentTime())}function b(){w=!0}function S(){}function k(){}function I(){e.isPaused()||e.$apply(function(){e.setPlayhead()})}function T(){i.setVolume(A.volume),e.updateVolumeBars(),e.$apply()}function L(){}function E(i){t.info(i+": NetState="+A.networkState+" ready="+A.readyState+" v_width="+A.videoWidth+" v_height="+A.videoHeight+" p_width="+A.width+" p_height="+A.height+" b_width="+e.width+" b_height="+e.height+" s_width="+screen.width+" s_height="+screen.height+" duration="+A.duration+" played="+(A.played.length?A.played.end(0):0)+" current="+(A.currentTime?A.currentTime:0)+" buffered="+(A.buffered.length?A.buffered.end(0):0)+" seek1="+(A.seekable.length?A.seekable.start(0):0)+" seek2="+(A.seekable.length?A.seekable.end(0):0))}t.info("DASH Controller constructor");var x=!1,w=!1,P=!1,H=!1,D="",A={};e.initController=function(e){t.info("DASH Controller init"),A=e;var i=angular.element(e);i.bind("abort",n),i.bind("canplay",r),i.bind("canplaythrough",s),i.bind("durationchange",a),i.bind("emptied",o),i.bind("ended",u),i.bind("error",l),i.bind("loadeddata",d),i.bind("loadedmetadata",h),i.bind("loadstart",c),i.bind("pause",m),i.bind("play",g),i.bind("playing",p),i.bind("progress",f),i.bind("ratechange",y),i.bind("seeked",v),i.bind("seeking",b),i.bind("stalled",S),i.bind("suspend",k),i.bind("timeupdate",I),i.bind("volumechange",T),i.bind("waiting",L)},e.cleanupController=function(){if(t.info("DASH Controller cleanup"),angular.isElement(A)){var e=angular.element(A);e.unbind("abort",n),e.unbind("canplay",r),e.unbind("canplaythrough",s),e.unbind("durationchange",a),e.unbind("emptied",o),e.unbind("ended",u),e.unbind("error",l),e.unbind("loadeddata",d),e.unbind("loadedmetadata",h),e.unbind("loadstart",c),e.unbind("pause",m),e.unbind("play",g),e.unbind("playing",p),e.unbind("progress",f),e.unbind("ratechange",y),e.unbind("seeked",v),e.unbind("seeking",b),e.unbind("stalled",S),e.unbind("suspend",k),e.unbind("timeupdate",I),e.unbind("volumechange",T),e.unbind("waiting",L)}},e.canPlaySource=function(e){var t=A.canPlayType(e);return"maybe"===t||"probably"===t?!0:!1},e.setSourceUrl=function(t){(""===e.getSourceUrl()||e.getSourceUrl()!==D)&&(A.src=t,x=!1,w=!1,P=!1,H=!1,D="")},e.getSourceUrl=function(){return A.currentSrc},e.setPosterUrl=function(e){A.poster=e},e.getPosterUrl=function(){return A.poster},e.setWidth=function(t){e.width=t,A.width=t},e.getWidth=function(){return e.width},e.getVideoWidth=function(){return A.videoWidth},e.setHeight=function(t){e.height=t,A.height=t},e.getHeight=function(){return e.height},e.getVideoHeight=function(){return A.videoHeight},e.load=function(){A.load()},e.isLoading=function(){return x},e.getNetworkState=function(){},e.getReadyState=function(){},e.play=function(){A.play(),H&&(H=!1)},e.pause=function(){A.pause()},e.isPaused=function(){return A.paused},e.isPlaying=function(){return!A.paused},e.isEnded=function(){return H},e.resetEnded=function(){H=!1},e.isSeekable=function(){},e.isSeeking=function(){},e.initVolume=function(){A.volume=i.getVolume()},e.setVolume=function(e){A.volume=e},e.getVolume=function(){return A.volume},e.getBuffered=function(){return A.buffered.length?A.buffered.end(0):0},e.getDuration=function(){return A.duration?A.duration:0},e.getCurrentTime=function(){return A.currentTime},e.setCurrentTime=function(e){A.currentTime=e},e.getError=function(){},e.seekToLive=function(){},e.isLive=function(){return!1}}]),angular.module("tsunami.directives").directive("hlsVideo",["$log",function(e){return{restrict:"A",priority:99,scope:!0,controller:"HLSVideoController",link:function(t,i,n){t.c={video:{id:0,title:"video"}},t.requestLive=angular.isDefined(n.live),t.requestAutoplay=angular.isDefined(n.autoplay),t.sources=i.children(),t.usedSource=-1,t.clearAutoplayObserver=function(){},t.clearLiveObserver=function(){},t.clearSourcesObserver=function(){},t.updateSource=function(e){if(angular.isDefined(e))for(var n=e.length,r=0;n>r;r++){var s=angular.element(e[r]).attr("src"),a=angular.element(e[r]).attr("type");if(""!==s&&t.canPlaySource(a)&&(t.usedSource=r,t.initEngine(i.get()[0],t.c.video),t.setSourceUrl(s,a))){t.c.video.title=s,t.requestLive?t.playLive():t.requestAutoplay?t.play():t.load();break}}},t.fallThrough=function(r){if(e.info("HLS Directive falling through to HTML5"),t.shutdownEngine(),t.clearAutoplayObserver(),t.clearLiveObserver(),t.clearSourcesObserver(),angular.isDefined(r))for(var s=i.get()[0],a=t.sources.length,o=0;a>o;o++)if(o!==t.usedSource){var u=angular.element(t.sources[o]).attr("src"),l=angular.element(t.sources[o]).attr("type"),d=s.canPlayType(l)||"not";if(e.info("Trying fallthrough source "+u+" -> "+d+" working"),"maybe"===d||"probably"===d){s.src=u,t.usedSource=o,n.$set("preload","metadata"),t.requestAutoplay&&n.$set("autoplay","");break}}},t.goLive=function(e){e||""===e?(t.requestLive=!0,t.seekToLive()):t.requestLive=!1},t.doAutoPlay=function(e){(e||""===e)&&t.play()},i.is("video")&&t._engine.isSupported()?(t.sources=i.children(),t.clearSourcesObserver=t.$watch("sources",t.updateSource),t.clearLiveObserver=n.$observe("live",t.goLive),i.removeAttr("autoplay"),t.clearAutoplayObserver=n.$observe("autoplay",t.doAutoPlay),n.$set("preload","none"),n.$set("controls","controls")):t.clearSourcesObserver=t.$watch("sources",t.fallThrough),t.$on("error",t.fallThrough)}}}]).controller("HLSVideoController",["$scope","HLSVideoEngine",function(e,t){e._engine=t.getInstance(),e.initEngine=function(t,i){return e._engine.init(t,e,i)},e.shutdownEngine=function(){return e._engine.shutdown()},e.setSourceUrl=function(t,i){return e._engine.setSourceUrl(t,i)},e.getSourceUrl=function(){return e._engine.getSourceUrl()},e.setPosterUrl=function(t){return e._engine.setPosterUrl(t)},e.getPosterUrl=function(){return e._engine.getPosterUrl()},e.getWidth=function(){return e._engine.getWidth()},e.getHeight=function(){return e._engine.getHeight()},e.setWidth=function(t){return e._engine.setWidth(t)},e.setHeight=function(t){return e._engine.setHeight(t)},e.getVideoWidth=function(){return e._engine.getVideoWidth()},e.getVideoHeight=function(){return e._engine.getVideoHeight()},e.canPlaySource=function(t){return e._engine.canPlaySource(t)},e.load=function(){return e._engine.load()},e.play=function(){return e._engine.play()},e.playLive=function(){return e._engine.playLive()},e.pause=function(){return e._engine.pause()},e.resetEnded=function(){return e._engine.resetEnded()},e.seekToLive=function(){return e._engine.seekToLive()},e.getBuffered=function(){return e._engine.getBuffered()},e.getDuration=function(){return e._engine.getDuration()},e.getCurrentTime=function(){return e._engine.getCurrentTime()},e.setCurrentTime=function(t){return e._engine.setCurrentTime(t)},e.isLoading=function(){return e._engine.isLoading()},e.isLive=function(){return e._engine.isLive()},e.isPlayingLive=function(){return e._engine.isPlayingLive()},e.isBuffering=function(){return e._engine.isBuffering()},e.isStalled=function(){return e._engine.isStalled()},e.isPaused=function(){return e._engine.isPaused()},e.isPlaying=function(){return e._engine.isPlaying()},e.isEnded=function(){return e._engine.isEnded()},e.isSeekable=function(){return e._engine.isSeekable()},e.isSeeking=function(){return e._engine.isSeeking()},e.initVolume=function(){return e._engine.initVolume()},e.getVolume=function(){return e._engine.getVolume()},e.setVolume=function(t){return e._engine.setVolume(t)},e.getNetworkState=function(){return e._engine.getNetworkState()},e.getReadyState=function(){return e._engine.getReadyState()},e.getError=function(){return e._engine.getError()}}]),angular.module("tsunami.directives").controller("HTML5VideoController",["$scope","HTML5VideoEngine",function(e,t){e._engine=t.getInstance(),e.initEngine=function(t,i){return e._engine.init(t,e,i)},e.shutdownEngine=function(){return e._engine.shutdown()},e.setSourceUrl=function(t){return e._engine.setSourceUrl(t)},e.getSourceUrl=function(){return e._engine.getSourceUrl()},e.setPosterUrl=function(t){return e._engine.setPosterUrl(t)},e.getPosterUrl=function(){return e._engine.getPosterUrl()},e.getWidth=function(){return e._engine.getWidth()},e.getHeight=function(){return e._engine.getHeight()},e.setWidth=function(t){return e._engine.setWidth(t)},e.setHeight=function(t){return e._engine.setHeight(t)},e.getVideoWidth=function(){return e._engine.getVideoWidth()},e.getVideoHeight=function(){return e._engine.getVideoHeight()},e.canPlaySource=function(t){return e._engine.canPlaySource(t)},e.load=function(){return e._engine.load()},e.play=function(){return e._engine.play()},e.playLive=function(){return!1},e.pause=function(){return e._engine.pause()},e.resetEnded=function(){return e._engine.resetEnded()},e.seekToLive=function(){return!1},e.getBuffered=function(){return e._engine.getBuffered()},e.getDuration=function(){return e._engine.getDuration()},e.getCurrentTime=function(){return e._engine.getCurrentTime()},e.setCurrentTime=function(t){return e._engine.setCurrentTime(t)},e.isLoading=function(){return e._engine.isLoading()},e.isLive=function(){return!1},e.isPlayingLive=function(){return!1},e.isBuffering=function(){return e._engine.isBuffering()},e.isStalled=function(){return e._engine.isStalled()},e.isPaused=function(){return e._engine.isPaused()},e.isPlaying=function(){return e._engine.isPlaying()},e.isEnded=function(){return e._engine.isEnded()},e.isSeekable=function(){return e._engine.isSeekable()},e.isSeeking=function(){return e._engine.isSeeking()},e.initVolume=function(){return e._engine.initVolume()},e.getVolume=function(){return e._engine.getVolume()},e.setVolume=function(t){return e._engine.setVolume(t)},e.getNetworkState=function(){return e._engine.getNetworkState()},e.getReadyState=function(){return e._engine.getReadyState()},e.getError=function(){return e._engine.getError()}}]),angular.module("tsunami.directives").directive("videoPlayer",["tsunami.config","$timeout","$log","$document","$compile","$controller","$injector",function(e,t,i,n,r,s,a){var o={theme:"simple",showTitle:!1,enableTrimmer:!1,showTrimmer:!1,enableMarker:!1,showMarker:!1,enableFullscreen:!1,fullscreenMode:"window",enableLive:!1,showVolume:!0,showThumbnails:!1,autoplay:!0,autohide:!0,width:640,height:360,thumbsource:"grid",gridx:8,gridy:10,engine:"HTML5Video",video:{}},u=e.videoplayer||{},l=angular.extend({},o,u),d="ontouchstart"in document.documentElement;return{restrict:"A",replace:!0,controller:"VideoPlayerEmptyController",templateUrl:"template/videoplayer.html",link:function(e,t,r){function o(){e.isError=!1,e.errorMsg="",e.buffered=0,e.played=0,e.currentTime=0,e.duration=0,e.playerWidth=l.width,e.playerHeight=l.height,e.savedWidth=l.width,e.savedHeight=l.height,e.hoverPos=0}function u(){o();var n;if(n=r.videoPlayer?e.$eval(r.videoPlayer):{},e.c=angular.extend({},e.c,l,n),m!==e.c.engine){angular.isFunction(e.shutdownEngine)&&e.shutdownEngine();var u=e.c.engine+"Controller",d=e.c.engine+"Engine";if(i.info("VideoPlayer: using engine "+d),f=s(u,{$scope:e,e:a.get(d)}),m=e.c.engine,!e._engine.isSupported())return f=s("VideoPlayerEmptyController",{$scope:e}),e.errorMsg="Error: "+d+" is not supported by your browser.",e.isError=!0,void 0;e.initEngine(t.children()[0],e.c.video)}e.showTrimmer=e.showTrimmer||e.c.enableTrimmer&&e.c.showTrimmer?!0:!1,e.playerWidth=e.c.width||l.width,e.playerHeight=e.c.height||l.height,e.setWidth(e.playerWidth),e.setHeight(e.playerHeight),h(),e.initVolume(),e.updateVolumeBars(),e.timeUpdateHandler(),e.bufferUpdateHandler(),e.c.autoplay&&e.isPaused()&&e.play(),e.$on("timeupdate",e.timeUpdateHandler),e.$on("bufferupdate",e.bufferUpdateHandler),e.$on("volumeupdate",e.updateVolumeBars),e.$on("error",e.engineErrorHandler),e.$on("seek",e.seekHandler)}function h(){e.getPosterUrl()!==e.c.video.posterUrl&&e.setPosterUrl(e.c.video.posterUrl);for(var t=0;e.c.video.videoSources.length>t;++t)if(e.canPlaySource(e.c.video.videoSources[t].mimeType)){if(e.getSourceUrl()==e.c.video.videoSources[t].videoUrl)break;if(e.setSourceUrl(e.c.video.videoSources[t].videoUrl,e.c.video.videoSources[t].mimeType)){e.load();break}}}function c(t){if(y){var i=angular.element(t.currentTarget),n=(d?t.originalEvent.targetTouches[0].clientX:t.clientX)-i.offset().left,r=Math.max(0,Math.min(n/i.width(),1),0);e.setVolume(r)}}function g(){e.isFullscreen?(e.playerWidth=e.savedWidth,e.playerHeight=e.savedHeight):(e.savedWidth=e.playerWidth,e.savedHeight=e.playerHeight,e.playerWidth=screen.width,e.playerHeight=screen.height),e.inFullscreen=!e.inFullscreen,e.$apply()}function p(){e.inFullscreen=!1}var m="",f=null;e.volumeFill=["100%","100%","100%","100%","100%","100%","100%"],e.volumeStops=[0,.14,.28,.42,.57,.71,.85,1],e.c=angular.copy(l),e.isError=!1,e.errorMsg="",e.buffered=0,e.played=0,e.currentTime=0,e.duration=0,e.playerWidth=e.c.width,e.playerHeight=e.c.height,e.savedWidth=e.c.width,e.savedHeight=e.c.height,e.isFullscreen=!1,e.isFullwindow=!1,e.isMouseOver=!1,e.showTrimmer=!1,e.$watch(r.videoPlayer,u,!0),e.timeUpdateHandler=function(t){var i=e.getCurrentTime(),n=e.getDuration(),r=n>0?100*i/n:0;e.played=r.toFixed(1),e.currentTime=i,e.duration=n,angular.isDefined(t)&&angular.isFunction(t.stopPropagation)&&t.stopPropagation()},e.bufferUpdateHandler=function(t){var i=e.getBuffered(),n=e.getDuration(),r=n>0?100*i/n:0;e.buffered=r.toFixed(1),e.currentTime=e.getCurrentTime(),e.duration=n,angular.isDefined(t)&&angular.isFunction(t.stopPropagation)&&t.stopPropagation()},e.engineErrorHandler=function(t,i,n,r){t.stopPropagation(),e.isFullscreen&&e.toggleFS(),e.isFullwindow&&e.toggleFullwindow(),e.errorMsg="Uups, we're sorry. Playback failed. <br/>"+r,e.isError=!0
};var y=!1;e.startSetVolume=function(i){return y=!0,t.bind("mousemove",c),n.bind("mouseup",e.stopSetVolume),angular.isDefined(i)&&(c(i),i.stopPropagation(),i.preventDefault()),!1},e.stopSetVolume=function(i){return y?(t.unbind("mousemove",c),n.unbind("mouseup",e.stopSetVolume),angular.isDefined(i)&&(c(i),i.stopPropagation(),i.preventDefault()),y=!1,!1):void 0},e.updateVolumeBars=function(){var t=e.getVolume(),i=0,n=140;angular.forEach(e.volumeFill,function(){if(t>=e.volumeStops[i+1])e.volumeFill[i]="100%";else if(e.volumeStops[i]>=t)e.volumeFill[i]="0%";else{var r=(t-e.volumeStops[i])/(e.volumeStops[i+1]-e.volumeStops[i])*n;e.volumeFill[i]=""+r.toFixed()+"%"}i++})},e.kickBar=function(e){var t=angular.element(e.currentTarget);t.finish();var i=t.height();t.animate({height:""+(i+5)+"px"},{queue:!0,duration:200}),t.animate({height:""+i+"px"},{queue:!0,duration:200})},e.playpause=function(){e.isEnded()?(e.setCurrentTime(0),e.play()):e.isPaused()?e.play():e.pause()},e.seekTo=function(t){var i=angular.element(t.currentTarget),n=(d?t.originalEvent.targetTouches[0].clientX:t.clientX)-i.offset().left,r=n/i.width()*e.getDuration();return e.setCurrentTime(r),e.timeUpdateHandler(),t.stopPropagation(),!1},e.seekLive=function(t){return e.seekToLive(),t.stopPropagation(),!1},e.seekHandler=function(t,i,n){return e.setCurrentTime(n),e.timeUpdateHandler(),t.stopPropagation(),!1},e.toggleFS=function(t){t.stopPropagation(),t.preventDefault(),e.c.enableFullscreen&&("window"===e.c.fullscreenMode?e.toggleFullwindow():e.toggleFullscreen())},e.toggleFullwindow=function(){e.isFullwindow?(e.playerWidth=e.savedWidth,e.playerHeight=e.savedHeight,e.isFullwindow=!1,$(document.body).css("overflow","")):(e.savedWidth=e.playerWidth,e.savedHeight=e.playerHeight,$(document.body).css("overflow","hidden"),e.playerWidth=$(window).width(),e.playerHeight=$(window).height(),e.isFullwindow=!0)},e.toggleFullscreen=function(){if(e.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen&&document.mozCancelFullScreen();else{var i=t.get(0);i.requestFullscreen?(n.unbind("fullscreenchange").bind("fullscreenchange",g),n.unbind("fullscreenerror").bind("fullscreenerror",p),i.requestFullscreen()):i.webkitRequestFullscreen?(n.unbind("webkitfullscreenchange").bind("webkitfullscreenchange",g),n.unbind("webkitbeginfullscreen").bind("webkitbeginfullscreen",g),n.unbind("webkitendfullscreen").bind("webkitendfullscreen",g),n.unbind("webkitfullscreenerror").bind("webkitfullscreenerror",p),i.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)):i.mozRequestFullScreen&&(n.unbind("mozfullscreenchange").bind("mozfullscreenchange",g),n.unbind("mozfullscreenerror").bind("mozfullscreenerror",p),i.mozRequestFullScreen())}},e.toggleTrimmer=function(t){return e.showTrimmer=!e.showTrimmer,t.stopPropagation(),t.preventDefault(),!1}}}}]).controller("VideoPlayerEmptyController",["$scope",function(e){e._engine=null,e.initEngine=function(){return!1},e.shutdownEngine=function(){return!1},e.setSourceUrl=function(){return!1},e.getSourceUrl=function(){return""},e.setPosterUrl=function(){return!1},e.getPosterUrl=function(){return""},e.getWidth=function(){return e.c.width},e.getHeight=function(){return e.c.height},e.setWidth=function(t){return e.c.width=t,!0},e.setHeight=function(t){return e.c.height=t,!0},e.getVideoWidth=function(){return e.width},e.getVideoHeight=function(){return e.height},e.canPlaySource=function(){return!1},e.load=function(){return!1},e.play=function(){return!1},e.playLive=function(){return!1},e.pause=function(){return!1},e.resetEnded=function(){return!1},e.seekToLive=function(){return!1},e.getBuffered=function(){return 0},e.getDuration=function(){return 0},e.getCurrentTime=function(){return 0},e.setCurrentTime=function(){return!1},e.isLoading=function(){return!1},e.isLive=function(){return!1},e.isPlayingLive=function(){return!1},e.isBuffering=function(){return!1},e.isStalled=function(){return!1},e.isPaused=function(){return!1},e.isPlaying=function(){return!1},e.isEnded=function(){return!1},e.isSeekable=function(){return!1},e.isSeeking=function(){return!1},e.initVolume=function(){return!1},e.getVolume=function(){return 0},e.setVolume=function(){return!1},e.getNetworkState=function(){return 0},e.getReadyState=function(){return 0},e.getError=function(){return 0}}]),angular.module("tsunami.directives").directive("videoThumbnail",["$timeout","$log",function(e,t){return{restrict:"A",replace:!0,templateUrl:"template/videothumbnail.html",controller:"VideoThumbnailCtrl",link:function(t,i,n){function r(e){if(void 0!==e){var i,r=t.c.video;i=n.videoThumbnail?t.$eval(n.videoThumbnail):{},angular.extend(t.c,i),t.c.selectable||t.selected&&(t.selected=!1,t.$emit("deselected",r)),t.c.autoplay||t.stopPlay(),t.thumburl=t.c.video.thumbnailUrl,t.waveurl=t.c.video.waveformUrl,d="grid"===t.c.sourcetype?160:0,h=0,g.css("background-position",""+d+"px "+(""+h)+"px")}}function s(){t.c.selectable&&(t.selected=!t.selected,t.selected?t.$emit("selected",t.c.video):t.$emit("deselected",t.c.video))}function a(){l=(l+1)%(t.c.gridx*t.c.gridy),u=e(function(){o(),a()},125)}function o(){d=l%t.c.gridy*-t.c.width,h=(0|l/t.c.gridy)*-t.c.height,g.css("background-position",""+d+"px "+(""+h)+"px"),t.skimmerWidth=~~(100*((l>0?l+1:0)/(t.c.gridx*t.c.gridy)))}t.selected=!1,t.thumburl="",t.waveurl="",t.skimmerWidth=0;var u,l=0,d=0,h=0,c=angular.element(i.children()[1]),g=angular.element(c.children()[0]);t.c={showtitle:!1,showmeta:!1,showwave:!0,selectable:!1,clickable:!1,autoplay:!0,skimmable:!0,sourcetype:"grid",gridx:8,gridy:10,width:160,height:90,video:{}},r(),t.$watch(n.videoThumbnail,r,!0),t.mouseClicked=function(){t.c.clickable&&t.$emit("clicked",t.c.video),s()},t.startPlay=function(){t.c.autoplay&&a()},t.stopPlay=function(){e.cancel(u)},t.skipTo=function(e){t.c.skimmable&&(l=~~((e.clientX-g.position().left)/t.c.width*t.c.gridx*t.c.gridy),o())},t.skipTo_Thumb=function(e){t.c.skimmable&&!t.c.autoplay&&t.skipTo(e)},t.$on("$destroy",function(){t.stopPlay()})}}}]).controller("VideoThumbnailCtrl",["$scope","$log",function(){}]),angular.module("tsunami.services").factory("BandwidthMonitor",function(){var e=function(){this.history=[],this.minIn=0,this.maxIn=0,this.avgIn=0,this.minOut=0,this.maxOut=0,this.avgOut=0,this.onOff=0,this.startTime=0,this.maxDepth=10,this.cache=0};return e.prototype.reset=function(){this.history.length=0,this.recalc(0)},e.prototype.setDepth=function(e){this.history.length=e,this.maxDepth=e,this.recalc(0)},e.prototype.insert=function(e,t,i,n){var r={startTime:e,endTime:t,bytes:isFinite(i)?i:0,dur:isFinite(n)?n:t-e};this.history.push(r)>this.maxDepth&&this.history.shift(),this.lastStartTime=e,this.startTime=0,this.cache=0},e.prototype.on=function(){this.startTime=(new Date).getTime()},e.prototype.off=function(e,t){var i=(new Date).getTime();this.startTime>0&&i>=this.startTime&&this.insert(this.startTime,i,e,t),this.startTime=0},e.prototype.cancel=function(){this.startTime=0},e.prototype.lastInKbps=function(){var e=0;if(this.history.length>0){var t=this.history.slice(-1)[0];e=8*t.bytes/((t.endTime-t.startTime)/1e3)/1e3}return e},e.prototype.avgInKbps=function(e){return this.cache!=e&&this.recalc(e),this.avgIn},e.prototype.minInKbps=function(e){return this.cache!=e&&this.recalc(e),this.minIn},e.prototype.maxInKbps=function(e){return this.cache!=e&&this.recalc(e),this.minIn},e.prototype.lastOutKbps=function(){var e=0;if(this.history.length>1){var t=this.history.slice(-1)[0],i=this.history.slice(-2)[0];e=8*i.bytes/((t.startTime-i.startTime)/1e3)/1e3}return e},e.prototype.avgOutKbps=function(e){return this.cache!=e&&this.recalc(e),this.avgOut},e.prototype.minOutKbps=function(e){return this.cache!=e&&this.recalc(e),this.minOut},e.prototype.maxOutKbps=function(e){return this.cache!=e&&this.recalc(e),this.minOut},e.prototype.onRatio=function(e){return this.cache!=e&&this.recalc(e),this.onOff},e.prototype.recalc=function(e){var t=this.history.length,i=0,n=0,r=(new Date).getTime(),s=void 0===e||0===e?0:r-1e3*e;this.cache=e,this.avgIn=0,this.avgOut=0,this.minIn=-1,this.minOut=-1,this.maxIn=0,this.maxOut=0;for(var a=t-1;a>=0;--a){var o,u,l,d,h=this.history[a];if(s>=h.endTime)break;h.startTime>=s?(o=h.endTime-h.startTime||1,l=8*h.bytes/(o/1e3)/1e3,u=h.dur,d=8*h.bytes/(u/1e3)/1e3,i+=o,n+=u):(o=h.endTime-s||1,l=8*h.bytes/(o/(h.endTime-h.startTime))/(o/1e3)/1e3,u=h.dur/(o/(h.endTime-h.startTime)),d=8*h.bytes/(u/1e3)/1e3,i+=o,n+=u),this.maxIn=Math.max(this.maxIn,l),this.minIn=-1==this.minIn?l:Math.min(this.minIn,l),this.avgIn=this.avgIn+(l-this.avgIn)/(t-a),this.maxOut=Math.max(this.maxOut,d),this.minOut=-1==this.minOut?d:Math.min(this.minOut,d),this.avgOut=this.avgOut+(d-this.avgOut)/(t-a)}this.onOff=n>0?i/n:0},{getInstance:function(){return new e}}}),angular.module("tsunami.services").factory("HLSVideoEngine",["$log","$http","$timeout","$q","sound","BandwidthMonitor","M3U8Parser",function(e,t,i,n,r,s,a){function o(t){switch(t){case 0:return"IDLE";case 1:return"BUFFERING";case 2:return"STEADY";case 3:return"LIVE";case 4:return"STALLED";default:e.error("Undefined stream state "+t)}}function u(t){switch(t){case 0:return"PAUSED";case 1:return"PLAYING";case 2:return"LIVE";case 3:return"SEEKING";case 4:return"SEEKLIVE";default:e.error("Undefined playback state "+t)}}function l(e){var t=e.indexOf(";");return-1===t&&(t=e.length),e.slice(0,t)}function d(e){var t=e.indexOf(";");return-1===t&&(t=e.length),e.slice(t+1)}function h(e){var t=e.indexOf("=");e.slice(0,t);var i=e.slice(t+1);return i.replace(/'/g,"")}var c={MediaSourceConstructor:window.MediaSource||window.WebKitMediaSource,faststart:!0,maxIndexReloadCount:5,bandwidthAverageTime:5,bufferLevelSteady:30,bufferLevelRebuffer:5,bufferLevelSteadyLive:2.5,bufferLevelRebufferLive:1.5,width:0,height:0},g=0,p={FRESH:0,INIT:1,LOADING:2,READY:3,FAILED:4},m={FIXED:1,APPEND:2,SLIDING:3},f={IDLE:0,BUFFERING:1,STEADY:2,LIVE:3,STALLED:4},y={PAUSED:0,PLAYING:1,LIVE:2,SEEKING:3,SEEKLIVE:4},v=function(){this.c=c,this.engineId=g++,this.engineState=p.FRESH,this.haveMeta=!1,this.eos=!1,this.currentSrcUrl="",this.scope=null,this.videoObject=null,this.player=null,this.mediaSource=null,this.sourceBuffer=null,this.index=null,this.indexParser=null,this.mimeType="",this.codecs="",this.streamState=f.IDLE,this.playbackState=y.PAUSED,this.playQueue=[],this.monitors=[],this.wasPlayingBeforeSeek=!1,this.wasLiveBeforeSeek=!1,this.segmentInProgress=!1,this.playerInitPromise_emptied=null,this.playerInitPromise_setup=null,this.playerInitPromise_sourceOpen=null,this.playerInitPromise_loadedMetadata=null,this.playerResetPromise=null,this.initPromise=null,this.inIndexLoop=!1,this.inBufferLoop=!1,this.inPollLoop=!1,this.indexTimeoutId=0,this.bufferTimeoutId=0,this.pollTimeoutId=0,this.haveIndex=!1,this.indexReloadCounter=0,this.seekTime=0};return v.prototype.init=function(e,t,i){if(this.engineState===p.FRESH&&(this.debugMsg("HLS Engine init: MediaSourceAPI="+this.hasMediaSourceSupport()),this.hasMediaSourceSupport()&&e&&t)){this.initialising=!0,this.player=e,this.scope=t,this.videoObject=i;var r=angular.element(e),s=this;r.bind("abort",angular.bind(this,this.abortHandler)),r.bind("canplay",angular.bind(this,this.canPlayHandler)),r.bind("canplaythrough",angular.bind(this,this.canPlayThroughHandler)),r.bind("durationchange",angular.bind(this,this.durationChangeHandler)),r.bind("emptied",angular.bind(this,this.emptiedHandler)),r.bind("ended",angular.bind(this,this.endedHandler)),r.bind("error",angular.bind(this,this.errorHandler)),r.bind("loadeddata",angular.bind(this,this.loadedDataHandler)),r.bind("loadedmetadata",angular.bind(this,this.loadedMetaDataHandler)),r.bind("loadstart",angular.bind(this,this.loadStartHandler)),r.bind("pause",angular.bind(this,this.pauseHandler)),r.bind("play",angular.bind(this,this.playHandler)),r.bind("playing",angular.bind(this,this.playingHandler)),r.bind("progress",angular.bind(this,this.progressHandler)),r.bind("ratechange",angular.bind(this,this.rateChangeHandler)),r.bind("seeked",angular.bind(this,this.seekedHandler)),r.bind("seeking",angular.bind(this,this.seekingHandler)),r.bind("stalled",angular.bind(this,this.stalledHandler)),r.bind("suspend",angular.bind(this,this.suspendHandler)),r.bind("timeupdate",angular.bind(this,this.timeupdateHandler)),r.bind("volumechange",angular.bind(this,this.volumeChangeHandler)),r.bind("waiting",angular.bind(this,this.waitingHandler)),this.player.preload="none",this.player.src="",this.playerInitPromise_emptied=n.defer(),this.playerInitPromise_setup=n.defer(),this.playerInitPromise_sourceOpen=n.defer(),this.playerInitPromise_loadedMetadata=n.defer(),this.engineState=p.INIT,this.playerInitPromise_emptied.promise.then(function(){var e=s;e.setupPlayer()},angular.bind(this,this.setupErrorHandler))}},v.prototype.shutdown=function(){if(this.engineState!==p.FRESH&&(this.debugMsg("HLS Engine cleanup"),this.hasMediaSourceSupport()&&angular.isElement(this.player))){var e=angular.element(this.player);e.unbind("abort"),e.unbind("canplay"),e.unbind("canplaythrough"),e.unbind("durationchange"),e.unbind("emptied"),e.unbind("ended"),e.unbind("error"),e.unbind("loadeddata"),e.unbind("loadedmetadata"),e.unbind("loadstart"),e.unbind("pause"),e.unbind("play"),e.unbind("playing"),e.unbind("progress"),e.unbind("ratechange"),e.unbind("seeked"),e.unbind("seeking"),e.unbind("stalled"),e.unbind("suspend"),e.unbind("timeupdate"),e.unbind("volumechange"),e.unbind("waiting"),this.shutdownPlayer(),this.player=null,this.videoObject=null,this.scope=null,this.engineState=p.FRESH}},v.prototype.isSupported=function(){return this.hasMediaSourceSupport()},v.prototype.scopeApply=function(e){if(this.scope){var t=this.scope.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.scope.$apply(e)}},v.prototype.abortHandler=function(){this.debugMsg("HLS abortHandler"),this.scopeApply()},v.prototype.canPlayHandler=function(){this.debugMsg("HLS canPlayHandler"),this.scopeApply()},v.prototype.canPlayThroughHandler=function(){this.debugMsg("HLS canPlayThroughHandler"),this.scope.$emit("loaded",this.videoObject,this.getBuffered()),this.scopeApply()},v.prototype.durationChangeHandler=function(e){this.debugBufferState("HLS durationChangeHandler"),e.stopPropagation&&e.stopPropagation(),this.updatePlayerState(),this.scope.$broadcast("timeupdate",this.videoObject,this.player.currentTime,this.getDuration()),this.scopeApply()},v.prototype.emptiedHandler=function(){this.debugMsg("HLS emptiedHandler"),this.engineState===p.INIT&&this.playerInitPromise_emptied&&this.playerInitPromise_emptied.resolve(),this.scope.$emit("bufferupdate",this.videoObject,this.player.currentTime,this.getBuffered()),this.scopeApply()},v.prototype.endedHandler=function(){this.debugMsg("HLS endedHandler"),this.eos=!0,this.scope.$emit("eos",this.videoObject,this.getCurrentTime()),this.scopeApply()},v.prototype.errorHandler=function(e){e.stopPropagation&&e.stopPropagation(),(""!==this.player.currentSrc||4!==this.player.error.code)&&(this.debugMsg("HLS ErrorHandler "),this.engineState=p.FAILED,this.resetPlayer(),this.scope.$emit("error",this.videoObject,this.player.currentTime,this.player.error),this.scopeApply())},v.prototype.loadedDataHandler=function(){this.debugMsg("HLS loadedDataHandler"),this.scopeApply()},v.prototype.loadedMetaDataHandler=function(){if(this.debugMsg("HLS loadedMetaDataHandler"),this.player.readyState>=1){if(0===this.c.width||0===this.c.height){var e=this.getVideoWidth(),t=this.getVideoHeight(),i=t/e;this.setWidth(this.c.width||this.c.height/i||e),this.setHeight(this.c.height||this.c.width*i||t)}this.haveMeta=!0,this.engineState=p.READY,this.playerInitPromise_loadedMetadata.resolve(),this.scopeApply()}},v.prototype.loadStartHandler=function(){this.debugMsg("HLS loadStartHandler"),this.engineState===p.INIT&&this.playerInitPromise_emptied.resolve(),this.scopeApply()},v.prototype.playHandler=function(){this.debugMsg("HLS playHandler"),this.playbackState===y.PLAYING||this.playbackState===y.LIVE||this.player.paused||this.setPlaybackState(y.PLAYING),this.scopeApply()},v.prototype.playingHandler=function(){this.debugBufferState("HLS playingHandler"),this.scope.$emit("playing",this.videoObject,this.getCurrentTime()),this.scopeApply()},v.prototype.pauseHandler=function(){this.debugBufferState("HLS pauseHandler"),this.playbackState!==y.PAUSED&&this.setPlaybackState(y.PAUSED),this.scope.$emit("paused",this.videoObject,this.getCurrentTime()),this.scopeApply()},v.prototype.progressHandler=function(){this.debugBufferState("HLS progressHandler"),this.updatePlayerState(),this.scope.$emit("bufferupdate",this.videoObject,this.player.currentTime,this.getBuffered()),this.scopeApply()},v.prototype.rateChangeHandler=function(){this.debugMsg("HLS rateChangeHandler"),this.scopeApply()},v.prototype.seekedHandler=function(){this.debugBufferState("HLS seekedHandler"),this.debugMsg("--- index seek to:"+this.player.currentTime+"s buf:"+this.getTimeBufferedAhead()+"s"),this.updatePlayerState(),this.scope.$emit("seeked",this.videoObject,this.getCurrentTime()),this.scopeApply()},v.prototype.seekingHandler=function(){this.isSeeking()||(this.seekTime=this.player.currentTime,this.index.seekTo(this.seekTime),this.setPlaybackState(y.SEEKING)),this.debugBufferState("HLS seekingHandler - new pos t:"+this.seekTime+" s:"+this.index.getSegmentIdFromTime(this.seekTime)),this.doSeeking(),this.scopeApply()},v.prototype.sourceOpenHandler=function(){this.debugMsg("HLS Media Source opened"),this.sourceBuffer=this.mediaSource.addSourceBuffer(this.index.getActiveVariantMimeTypeWithCodec()),this.player.preload="metadata",this.pushNextSegment(),this.mediaSource.duration=this.index.getDuration(),this.playerInitPromise_sourceOpen.resolve()},v.prototype.sourceEndedHandler=function(){this.debugMsg("HLS Player ended")},v.prototype.sourceCloseHandler=function(){this.debugMsg("HLS Player closed"),this.playerResetPromise&&this.playerResetPromise.resolve(),this.scopeApply()},v.prototype.stalledHandler=function(){this.debugBufferState("HLS stalledHandler"),this.setStreamState(f.STALLED),this.scopeApply()},v.prototype.suspendHandler=function(){this.debugMsg("HLS suspendHandler"),this.scopeApply()},v.prototype.timeupdateHandler=function(e){e.stopPropagation&&e.stopPropagation(),this.updatePlayerState(),this.scope.$emit("timeupdate",this.videoObject,this.player.currentTime,this.getDuration()),this.scopeApply()},v.prototype.volumeChangeHandler=function(){this.debugMsg("HLS volumeChangeHandler"),r.setVolume(this.player.volume),this.scope.$emit("volumeupdate",this.videoObject,this.player.volume),this.scopeApply()},v.prototype.waitingHandler=function(){this.debugMsg("HLS waitingHandler"),this.scopeApply()},v.prototype.canPlaySource=function(e){var t=angular.lowercase(e).replace(" ",""),i=!1;if(this.hasMediaSourceSupport()){var n=l(t),r=d(t);if("application/x-mpegurl"===n||"vnd.apple.mpegurl"===n){var s=r.indexOf("="),a=r.slice(0,s),o=r.slice(s+1);o=o.replace(/'/g,""),"profile"===a?("video/webm"===o||"video/webm;codecs=vp8"===o||"video/webm;codecs=vp8,vorbis"===o)&&(i=!0):i=!0}}return this.debugMsg("HLS canPlaySource "+e+" => "+i),i},v.prototype.setSourceUrl=function(e,t){this.debugMsg("HLS setSourceUrl "+e);var i=!1;return this.hasMediaSourceSupport()&&""!==e&&e!==this.currentSrcUrl&&(this.currentSrcUrl=e,t&&(this.mimeType=l(t),this.codecs=h(d(t))),i=!0),""===e&&(this.resetPlayer(),this.mimeType="",this.codecs="",i=!0),i},v.prototype.getSourceUrl=function(){return this.currentSrcUrl},v.prototype.setPosterUrl=function(e){this.player.poster=e},v.prototype.getPosterUrl=function(){return this.player.poster},v.prototype.setWidth=function(e){this.c.width=e,this.player.width=e},v.prototype.getWidth=function(){return this.player.width},v.prototype.getVideoWidth=function(){return this.player.videoWidth},v.prototype.setHeight=function(e){this.c.height=e,this.player.height=e},v.prototype.getHeight=function(){return this.player.height},v.prototype.getVideoHeight=function(){return this.player.videoHeight},v.prototype.load=function(){this.loadInternal().then(null,angular.bind(this,this.initErrorHandler))},v.prototype.isLoading=function(){return this.engineState===p.LOADING},v.prototype.getNetworkState=function(){return this.player.networkState},v.prototype.getReadyState=function(){return this.player.readyState},v.prototype.play=function(){this.debugMsg("HLS play");var e=this;""!==this.currentSrcUrl&&(this.eos&&(this.eos=!1),this.engineState!==p.READY?this.loadInternal().then(function(){var t=e;t.setPlaybackState(y.PLAYING)},angular.bind(this,this.initErrorHandler)):this.setPlaybackState(y.PLAYING))},v.prototype.playLive=function(){this.debugMsg("HLS playLive");var e=this;""!==this.currentSrcUrl&&(this.eos&&(this.eos=!1),this.engineState!==p.READY?this.loadInternal().then(function(){var t=e;t.setPlaybackState(y.LIVE),t.seekToLive()},angular.bind(this,this.initErrorHandler)):(this.setPlaybackState(y.LIVE),this.seekToLive()))},v.prototype.pause=function(){this.engineState===p.READY&&this.setPlaybackState(y.PAUSED)},v.prototype.isLive=function(){return this.haveIndex?!this.index.getActiveVariant().eos:!1},v.prototype.isPlayingLive=function(){return this.isLive()&&this.playbackState===y.LIVE},v.prototype.isBuffering=function(){var e=this.c.faststart?this.isBufferLevelCritical():!this.isBufferLevelSteady();return this.streamState===f.BUFFERING&&e||this.playbackState===y.SEEKING||this.playbackState===y.SEEKLIVE},v.prototype.isStalled=function(){return this.streamState===f.STALLED},v.prototype.isPaused=function(){return this.playbackState===y.PAUSED},v.prototype.isPlaying=function(){return this.playbackState===y.PLAYING||this.playbackState===y.LIVE},v.prototype.isEnded=function(){return this.eos},v.prototype.resetEnded=function(){this.eos=!1},v.prototype.isSeekable=function(){return!0},v.prototype.isSeeking=function(){return this.playbackState===y.SEEKING||this.playbackState===y.SEEKLIVE},v.prototype.initVolume=function(){this.player.volume=r.getVolume()},v.prototype.setVolume=function(e){this.player.volume=e},v.prototype.getVolume=function(){return this.player.volume},v.prototype.getBuffered=function(){return this.engineState!==p.READY?0:this.getBufferLevel()+this.getCurrentTime()},v.prototype.getDuration=function(){return this.engineState!==p.READY?0:this.index.getActiveVariant().indexedDuration},v.prototype.getCurrentTime=function(){if(this.engineState!==p.READY)return 0;var e=this.index.getActiveVariant(),t=0;return t=this.playbackState===y.LIVE||e.style===m.SLIDING?e.indexedDuration:this.playbackState===y.SEEKING||this.playbackState===y.SEEKLIVE?this.seekTime:this.player.currentTime},v.prototype.setCurrentTime=function(e){return this.engineState!==p.READY?0:(this.debugMsg("HLS Seek: setting play pos to:"+e+" seg:"+this.index.getSegmentIdFromTime(e)),this.seekTime=e,this.player.currentTime=e,this.index.seekTo(e),this.setPlaybackState(y.SEEKING),void 0)},v.prototype.seekToLive=function(){this.engineState===p.READY&&this.isLive()&&this.setPlaybackState(y.SEEKLIVE)},v.prototype.getError=function(){return this.player.error},v.prototype.hasMediaSourceSupport=function(){return angular.isDefined(window.MediaSource)||angular.isDefined(window.WebKitMediaSource)},v.prototype.setupPlayer=function(){if(this.debugMsg("HLS setupPlayer"),this.engineState===p.INIT)try{this.indexParser=a.getInstance(),this.index={},this.index.activeVariant=0,this.monitors.push(s.getInstance()),this.mediaSource=new this.c.MediaSourceConstructor;var e=angular.element(this.mediaSource);e.bind("webkitsourceopen",angular.bind(this,this.sourceOpenHandler)),e.bind("webkitsourceended",angular.bind(this,this.sourceEndedHandler)),e.bind("webkitsourceclose",angular.bind(this,this.sourceCloseHandler)),e.bind("sourceopen",angular.bind(this,this.sourceOpenHandler)),e.bind("sourceended",angular.bind(this,this.sourceEndedHandler)),e.bind("sourceclose",angular.bind(this,this.sourceCloseHandler)),this.playerInitPromise_setup.resolve()}catch(t){this.playerInitPromise_setup.reject(),this.resetPlayer()}},v.prototype.initPlayer=function(){if(this.debugMsg("HLS initPlayer"),this.engineState!==p.LOADING||!this.haveIndex)return this.debugMsg("HLS init called in wrong state"),n.reject("init called in wrong state");var e=this.index.getActiveVariantMimeTypeWithCodec(),t=this.player.canPlayType(e);return"maybe"===t||"probably"===t?this.index.activeVariant>0?(this.debugMsg("--- does not support multi-variant streams yet"),n.reject("multi-variant streams are unsupported")):(this.player.src=window.URL.createObjectURL(this.mediaSource),this.player.load(),n.all([this.playerInitPromise_emptied.promise,this.playerInitPromise_setup.promise,this.playerInitPromise_sourceOpen.promise,this.playerInitPromise_loadedMetadata.promise])):(debugMsg("HLS init found unsupported media type "+e),n.reject("unsupported media type "+e))},v.prototype.shutdownPlayer=function(){this.debugMsg("HLS shutdownPlayer");try{this.resetPlayer();var e=angular.element(this.mediaSource);e.unbind("webkitsourceopen"),e.unbind("webkitsourceended"),e.unbind("webkitsourceclose"),e.unbind("sourceopen"),e.unbind("sourceended"),e.unbind("sourceclose"),this.mediaSource=null}catch(t){}},v.prototype.resetPlayer=function(){try{if(this.engineState<=p.INIT)return;this.debugMsg("HLS resetPlayer"),this.playerResetPromise=n.defer(),stopBufferLoop(),stopIndexLoop(),stopPollLoop(),this.indexParser.reset(),flushSegments(),angular.isDefined(this.sourceBuffer)&&this.mediaSource.removeSourceBuffer(this.sourceBuffer),""!==this.player.currentSrc&&(this.player.src="",this.currentSrcUrl=""),this.haveMeta=!1,this.haveIndex=!1,this.eos=!1,this.streamState=f.IDLE,this.playbackState=y.PAUSED,this.engineState=p.INIT,this.playerInitPromise_emptied.reject(),this.playerInitPromise_setup.reject(),this.playerInitPromise_sourceOpen.reject(),this.playerInitPromise_loadedMetadata.reject()}catch(e){}return this.playerResetPromise.promise},v.prototype.loadErrorHandler=function(e){return this.debugMsg("HLS loadErrorHandler"),this.playerInitPromise_loadedMetadata.reject(e.data),this.initialising=!1,this.engineState=p.FAILED,this.scope.$emit("error",this.videoObject,0,"loading video index file failed"),this.scopeApply(),n.reject("loading video index file failed")},v.prototype.setupErrorHandler=function(){return this.debugMsg("HLS setupErrorHandler"),this.playerInitPromise_setup.reject(),this.initialising=!1,this.engineState=p.FAILED,this.scope.$emit("error",this.videoObject,0,"player setup failed"),this.scopeApply(),n.reject("player setup failed")},v.prototype.initErrorHandler=function(){return this.debugMsg("HLS initErrorHandler"),this.engineState!==p.FRESH&&this.engineState!==p.FAILED?(this.playerInitPromise_sourceOpen.reject(),this.initialising=!1,this.engineState=p.FAILED,this.scope.$emit("error",this.videoObject,0,"player initialisation failed"),this.scopeApply(),n.reject("player init failed")):void 0},v.prototype.indexErrorHandler=function(){return this.debugMsg("HLS indexErrorHandler"),this.initialising=!1,this.engineState=p.FAILED,this.scope.$emit("error",this.videoObject,0,"index file parsing failed"),this.scopeApply(),n.reject("index parsing failed")},v.prototype.loadInternal=function(){if(this.debugMsg("HLS loadInternal"),this.engineState===p.LOADING)return this.errorMsg("HLS failed: already loading"),this.initPromise;if(""===this.currentSrcUrl)return this.errorMsg("HLS failed: empty source"),n.reject("empty source url");var e=this;return this.initPromise=this.playerInitPromise_setup.promise.then(function(){var t=e;return t.engineState=p.LOADING,e.fetchIndex().then(function(){var t=e;return t.fetchSegment(!1).then(function(){var t=e;return t.initPlayer()},angular.bind(e,e.loadErrorHandler))},angular.bind(e,e.indexErrorHandler))},angular.bind(e,e.setupErrorHandler)),this.initPromise},v.prototype.fetchIndex=function(){this.debugMsg("HLS Fetching Index from "+this.currentSrcUrl);var e=(new Date).getTime(),i=this;return t({method:"GET",url:this.currentSrcUrl,cache:!1,timeout:2e3,headers:{Accept:"application/x-mpegurl, vnd.apple.mpegurl"},transformResponse:function(t,r){var s=i,a=s.currentSrcUrl,o=e;return r(),s.indexParser.parse(t,a,o)?(s.index=s.indexParser.getIndex(),s.haveIndex=!0,this.engineState===p.READY&&s.index.hasChanged&&(s.mediaSource.duration=s.index.getDuration()),""!==s.mimeType&&"*/*"===s.index.getActiveVariantMimeType()&&s.index.setActiveVariantMimeType(s.mimeType),""!==s.codecs&&"*/*"===s.index.getActiveVariantMimeTypeWithCodec()&&s.index.setActiveVariantMimeTypeWithCodec(s.codecs),t):(s.debugMsg("HLS error parsing index file"),s.haveIndex?t:n.reject("index parse error: "+s.indexParser.getError()))}})},v.prototype.doSeeking=function(){try{this.flushSegments(),this.sourceBuffer.abort(),this.setStreamState(f.BUFFERING),this.debugBufferState("HLS seeked to time: "+this.seekTime+" seg:"+this.index.getCurrentSegmentId())}catch(e){this.resetPlayer().then(this.loadInternal)}},v.prototype.fetchSegment=function(e){var i=this;if(!this.haveIndex)return this.errorMsg("HLS fetchSegment: no index loaded yet"),n.reject("no index loaded");if(this.segmentInProgress)return this.errorMsg("HLS fetchSegment: already in progress"),n.reject("segment in progress");this.segmentInProgress=!0;var r=this.index.getCurrentSegmentId(),s=this.index.getCurrentPlaylistItem();return this.monitors[this.index.activeVariant].on(),t({method:"GET",url:s.url,headers:{Accept:this.index.getActiveVariantMimeType()},responseType:"arraybuffer",transformResponse:function(t,a){var o=i,u=r,l=s,d=e,h=o.index.activeVariant;return o.segmentInProgress=!1,void 0===t||null===t||""===t?n.reject("segment load error"):(o.monitors[h].off(t.byteLength,1e3*l.duration),headers=a(),"*/*"==o.index.getActiveVariantMimeType()&&(o.index.setActiveVariantMimeType(headers["content-type"]),o.index.setActiveVariantMimeTypeWithCodec(headers["content-type"]+'; codecs="vp8, vorbis"')),o.playQueue.push(new Uint8Array(t)),d&&o.pushNextSegment(),u)},cache:this.index.getActiveVariant().allowCache,timeout:2*1e3*this.index.getSegmentDuration()})},v.prototype.pushNextSegment=function(){this.playQueue.length>0&&(this.mediaSource.sourceBuffers.updating||this.sourceBuffer.appendBuffer(this.playQueue.shift()))},v.prototype.flushSegments=function(){this.playQueue.length=0},v.prototype.restartIndexLoop=function(){this.stopIndexLoop(),this.indexLoop()},v.prototype.stopIndexLoop=function(){i.cancel(this.indexTimeoutId),this.inIndexLoop=!1},v.prototype.indexLoop=function(){var e=this;return this.inIndexLoop?(this.errorMsg("HLS Indexloop already running!"),void 0):this.engineState!==p.READY?(this.errorMsg("HLS Stopping Indexloop since player is not ready!"),void 0):(this.haveIndex&&this.index.getActiveVariant().eos||(this.inIndexLoop=!0,this.fetchIndex().then(function(){var t=e;if(t.engineState!==p.READY)return t.inIndexLoop=!1,void 0;if(!t.index.getActiveVariant().eos){t.shouldPrefetch()&&t.setStreamState(f.BUFFERING);var n=(new Date).getTime(),r=Math.max(0,t.index.reload_at-n);t.debugMsg("HLS indexLoop reloading in "+r+"ms"),t.indexTimeoutId=i(function(){var t=e;t.indexLoop()},r)}t.indexReloadCounter=0,t.inIndexLoop=!1},function(){var t=e;if(t.indexReloadCounter++,t.indexReloadCounter<t.c.maxIndexReloadCount){var n=1e3*t.index.getSegmentDuration()/2;t.debugMsg("HLS indexLoop reloading after FAIL in "+n+"ms"),t.indexTimeoutId=i(function(){var t=e;t.indexLoop()},n)}else t.errorMsg("HLS indexLoop failed reloading for "+t.indexReloadCounter+" times"),t.index.forceEOS();t.inIndexLoop=!1})),void 0)},v.prototype.getTimeBufferedAhead=function(e){for(var t=e||this.player.currentTime||0,i=this.player.buffered,n=angular.isDefined(i)?i.length:0,r=0;n>r;++r)if(t>=i.start(r)&&i.end(r)>=t)return i.end(r)-t;var s="";for(r=0;n>r;++r)s+=i.start(r)+":"+i.end(r)+" ";return this.errorMsg("No buffer range found for time "+t+" in "+n+" ranges "+s),0},v.prototype.isBuffered=function(e){for(var t=this.player.buffered,i=angular.isDefined(t)?t.length:0,n=0;i>n;++n)if(e>=t.start(n)&&t.end(n)>=e)return!0;
return!1},v.prototype.getBufferLevel=function(e){if(this.engineState!==p.READY)return 0;var t=this.getTimeBufferedAhead(e),i=this.playQueue.length*this.index.getSegmentDuration();return t+i},v.prototype.isBufferLevelSteady=function(){return this.isLive()&&this.playbackState===y.LIVE?this.getBufferLevel()>=this.c.bufferLevelSteadyLive:this.getBufferLevel()>=this.c.bufferLevelSteady},v.prototype.isBufferLevelCritical=function(){return this.isLive()&&this.playbackState===y.LIVE?this.getBufferLevel<=this.c.bufferLevelRebufferLive:this.getBufferLevel()<=this.c.bufferLevelRebuffer},v.prototype.getCurrentBitrate=function(){var e=this.index.getActiveVariant().bitrate,t=this.monitors[this.index.activeVariant].avgOutKbps(this.c.bandwidthAverageTime);return void 0!==e&&0!==e?e:t},v.prototype.getCurrentBandwidth=function(){return this.monitors[this.index.activeVariant].avgInKbps(this.c.bandwidthAverageTime)},v.prototype.getSegmentTimeToArrival=function(){var e=this.getCurrentBitrate()||1,t=this.getCurrentBandwidth()||1,i=this.index.getSegmentDuration();return i*e/t},v.prototype.getLiveTime=function(){return this.index.getDuration()-this.c.bufferLevelSteadyLive-this.getSegmentTimeToArrival()},v.prototype.shouldPrefetch=function(){return this.playbackState!==y.LIVE&&1.1*this.getCurrentBandwidth()<this.getCurrentBitrate()},v.prototype.startBufferLoop=function(){this.debugMsg("--- starting BufferLoop"),this.bufferLoop()},v.prototype.stopBufferLoop=function(){this.debugMsg("--- cancel BufferLoop"),i.cancel(this.bufferTimeoutId),this.inBufferLoop=!1},v.prototype.bufferLoop=function(){if(this.debugBufferState("HLS Bufferloop"),this.inBufferLoop)return this.errorMsg("--- Bufferloop already running!"),void 0;if(this.engineState!==p.READY)return this.errorMsg("--- Stopping BufferLoop since player is not ready!"),void 0;if(this.streamState!==f.BUFFERING)return this.debugMsg("--- Stopping BufferLoop after state changed to "+this.streamState),void 0;this.inBufferLoop=!0;var e=this;this.scheduleStreamRequest(function(t){var n=e;if(n.debugMsg("HLS schedule/buffer SUCCESS CALLBACK seg "+t.data),n.streamState===f.BUFFERING){var r=n.playbackState===y.LIVE?1e3*n.index.getSegmentDuration():0;r-=n.getSegmentTimeToArrival(),n.debugMsg("--- reschedule in "+r+"ms"),n.bufferTimeoutId=i(function(){var t=e;t.bufferLoop()},r,!1)}},function(t){var n=e;if(n.errorMsg("HLS schedule FAIL CALLBACK seg "+t.data),n.streamState===f.BUFFERING){var r=n.playbackState===y.PAUSED||n.playbackState===y.LIVE?1e3*n.index.getSegmentDuration():0;r-=getSegmentTimeToArrival(),n.debugMsg("--- reschedule in "+r+"ms"),n.bufferTimeoutId=i(function(){var t=e;t.bufferLoop()},r,!1)}}),this.inBufferLoop=!1},v.prototype.startPollLoop=function(){this.debugMsg("--- start PollLoop"),this.pollLoop()},v.prototype.stopPollLoop=function(){this.debugMsg("--- cancel PollLoop"),i.cancel(this.pollTimeoutId),this.inPollLoop=!1},v.prototype.pollLoop=function(){if(this.debugMsg("HLS PollLoop"),this.inPollLoop)return this.errorMsg("--- PollLoop already running!"),void 0;if(this.engineState!==p.READY)return this.errorMsg("--- Stopping PollLoop since player is not ready!"),void 0;if(this.streamState!==f.STALLED)return this.debugMsg("--- Stopping PollLoop after state changed to "+this.streamState),void 0;var e=this;this.scheduleStreamRequest(function(t){var n=e;if(n.debugMsg("HLS schedule/poll SUCCESS CALLBACK seg "+t.data),n.streamState===f.STALLED){var r=1e3*n.index.getSegmentDuration(),s=n.playbackState===y.LIVE?r/2:r;s-=n.getSegmentTimeToArrival(),n.debugMsg("--- reschedule in "+s+"ms"),n.pollTimeoutId=i(function(){var t=e;t.pollLoop()},s,!1)}},function(t){this.errorMsg("HLS schedule FAIL CALLBACK seg "+t.data);var n=e;if(n.streamState===f.STALLED){var r=1e3*n.index.getSegmentDuration,s=n.playbackState===y.LIVE?r/2:r;s-=n.getSegmentTimeToArrival(),n.debugMsg("--- reschedule in "+s+"ms"),n.pollTimeoutId=i(function(){var t=e;t.pollLoop()},s,!1)}}),this.inPollLoop=!1},v.prototype.updatePlayerState=function(){if(this.engineState===p.READY){this.debugBufferState("HLS updatePlayerState");var e=0;switch(this.playbackState){case y.PAUSED:break;case y.PLAYING:this.streamState===f.STALLED&&(this.debugMsg("--- switching to BUFFERING after stall"),this.setStreamState(f.BUFFERING)),(this.c.faststart&&!this.isBufferLevelCritical()||this.index.getActiveVariant().eos&&this.player.currentTime+this.getBufferLevel()>=this.index.getDuration())&&this.player.play();break;case y.LIVE:this.streamState===f.STALLED&&(e=this.getLiveTime(),this.debugMsg("--- live buffer level at "+e+" = "+this.getBufferLevel(e)),this.getBufferLevel(e)>=this.c.bufferLevelSteadyLive?(this.debugMsg("--- switching to LIVE after stall and skip to "+e),this.seekTime=e,this.player.currentTime=e,this.setStreamState(f.LIVE)):this.debugMsg("--- live buffer level too low for switching to "+e));break;case y.SEEKING:(this.streamState===f.STALLED||this.streamState===f.IDLE)&&(this.debugMsg("--- switching to BUFFERING state after stall"),this.setStreamState(f.BUFFERING)),(this.isBufferLevelSteady()||this.c.faststart&&this.isBufferLevelCritical()||this.seekTime>=this.index.getDuration()-this.index.getSegmentDuration()&&this.getBufferLevel(this.seekTime)>0||this.seekTime===this.getDuration()&&this.isBuffered(this.seekTime))&&(this.player.currentTime.toFixed(2)!==this.seekTime.toFixed(2)&&(this.debugMsg("--- setting new seek time again: "+this.seekTime),this.player.currentTime=this.seekTime),this.player.currentTime===this.index.getDuration()&&(this.debugMsg("--- rewind one frame at seek to end"),this.player.currentTime=this.player.currentTime-.1),this.wasLiveBeforeSeek?this.setPlaybackState(y.LIVE):this.wasPlayingBeforeSeek?this.setPlaybackState(y.PLAYING):this.setPlaybackState(y.PAUSED));break;case y.SEEKLIVE:this.streamState===f.STALLED&&(e=this.getLiveTime(),this.debugMsg("--- live buffer level at "+e+" = "+this.getBufferLevel(e)),this.getBufferLevel(e)>=this.c.bufferLevelRebufferLive?(this.debugMsg("--- switching to LIVE after stall and skip to "+e),this.seekTime=e,this.player.currentTime=e,this.setStreamState(f.LIVE)):this.debugMsg("--- live buffer level too low for switching to "+e)),this.player.currentTime.toFixed(2)!=this.seekTime.toFixed(2)&&this.player.duration>=this.seekTime&&(this.debugMsg("--- setting new seek time again: "+this.seekTime),this.player.currentTime=this.seekTime,this.setPlaybackState(y.LIVE))}}},v.prototype.setStreamState=function(e){this.debugMsg("HLS setStreamState "+o(this.streamState)+"->"+o(e));var t=this.streamState;switch(this.streamState=e,e){case f.BUFFERING:if(t===f.BUFFERING)break;this.startBufferLoop();break;case f.IDLE:this.stopBufferLoop(),this.stopPollLoop();break;case f.LIVE:this.stopPollLoop(),this.playbackState==y.PAUSED?(this.debugMsg("--- overwrite to IDLE"),this.streamState=f.IDLE):(this.playbackState==y.PLAYING||this.playbackState==y.LIVE)&&this.player.paused&&(this.debugMsg("--- resuming playback"),this.player.play());break;case f.STEADY:this.playbackState==y.PAUSED?(this.debugMsg("--- overwrite to IDLE"),this.streamState=f.IDLE):(this.playbackState==y.PLAYING||this.playbackState==y.LIVE)&&this.player.paused&&(this.debugMsg("--- resuming playback"),this.player.play());break;case f.STALLED:if(this.index.getActiveVariant().eos&&this.index.getCurrentSegmentId()==this.index.getLastSegmentId()){this.debugMsg("--- overwrite to IDLE on EOS"),this.streamState=f.IDLE;break}this.playbackState!=y.PAUSED?(this.stopBufferLoop(),this.stopPollLoop(),this.startPollLoop(),this.player.playing&&(this.debugMsg("--- pausing playback"),this.player.pause())):(this.debugMsg("--- overwrite to IDLE"),this.streamState=f.IDLE)}},v.prototype.setPlaybackState=function(e){this.debugMsg("HLS setPlaybackState "+u(this.playbackState)+"->"+u(e));var t=this.playbackState;switch(this.playbackState=e,e){case y.PLAYING:t!==y.PLAYING&&t!==y.LIVE&&(this.restartIndexLoop(),(this.streamState===f.IDLE||this.streamState===f.STALLED)&&(this.isBufferLevelSteady()?(this.debugMsg("--- enter STEADY at play"),this.setStreamState(f.STEADY)):(this.debugBufferState("--- enter BUFFERING at play"),this.setStreamState(f.BUFFERING))));break;case y.PAUSED:t!==y.PAUSED&&(this.stopIndexLoop(),this.player.pause(),this.streamState!==f.LIVE&&this.streamState!==f.STALLED?(this.debugBufferState("--- enter BUFFERING at pause"),this.setStreamState(f.BUFFERING)):(this.debugBufferState("--- enter IDLE at pause"),this.setStreamState(f.IDLE)));break;case y.LIVE:t!==y.LIVE&&(this.restartIndexLoop(),this.isBufferLevelSteady()?(this.debugMsg("--- enter LIVE at play live"),this.setStreamState(f.LIVE)):(this.debugBufferState("--- enter STALLED at play live"),this.setStreamState(f.STALLED)));break;case y.SEEKING:this.wasPlayingBeforeSeek=t===y.PLAYING||t===y.LIVE,this.wasLiveBeforeSeek=t===y.LIVE,this.index.prev();break;case y.SEEKLIVE:this.wasPlayingBeforeSeek=!0,this.wasLiveBeforeSeek=!0,this.seekTime=this.getLiveTime(),this.index.seekTo(this.seekTime),this.player.currentTime=this.seekTime,this.index.prev()}},v.prototype.scheduleStreamRequest=function(e,t){switch(this.pushNextSegment(),this.streamState){case f.IDLE:break;case f.STALLED:if(this.debugBufferState("HLS schedule [STALLED]"),!this.segmentInProgress&&this.index.hasMoreSegments()){if(this.playbackState===y.LIVE){var n=this.getLiveTime();this.debugMsg("--- skipping index to live "+n),this.index.seekTo(n),this.isBuffered(n)&&(this.debugMsg("--- already buffered -> index++"),this.index.next())}else this.index.next();this.debugMsg("--- segment "+this.index.getCurrentSegmentId()+" TTA="+this.getSegmentTimeToArrival()+"s"),this.fetchSegment(!0).then(e,t)}else angular.isFunction(e)&&e(this.index.getCurrentSegmentId());break;case f.BUFFERING:if(this.debugBufferState("HLS schedule [BUFFERING]"),this.index.getActiveVariant().style===m.FIXED&&!this.index.hasMoreSegments()){this.playbackState===y.SEEKING?(this.debugMsg("--- last segment "+this.index.getCurrentSegmentId()+" TTA="+this.getSegmentTimeToArrival()+"s"),this.fetchSegment(!0).then(e,t)):this.inBufferLoop||this.inPollLoop?(this.debugMsg("--- no more segments in VOD, ending fetching."),this.setStreamState(f.IDLE)):(this.debugMsg("--- no more segments in VOD, ending fetching."),this.setStreamState(f.IDLE),this.updatePlayerState());break}if(this.isBufferLevelSteady()&&!this.shouldPrefetch()||!this.index.hasMoreSegments()){this.debugMsg("--- leaving BUFFERING state"),this.setStreamState(f.STEADY);break}!this.segmentInProgress&&this.index.hasMoreSegments()?(this.index.next(),this.debugMsg("--- segment "+this.index.getCurrentSegmentId()+" TTA="+this.getSegmentTimeToArrival()+"s"),this.fetchSegment(!0).then(e,t)):angular.isFunction(e)&&e(this.index.getCurrentSegmentId());break;case f.LIVE:this.debugBufferState("HLS schedule [LIVE]"),!this.segmentInProgress&&this.index.hasMoreSegments()&&(this.index.next(),this.debugMsg("--- segment "+this.index.getCurrentSegmentId()+" TTA="+this.getSegmentTimeToArrival()+"s"),this.fetchSegment(!0).then(e,t));break;case f.STEADY:if(this.debugBufferState("HLS schedule [STEADY]"),this.isBufferLevelCritical()&&this.playbackState!==y.LIVE){this.debugMsg("--- switch to BUFFERING on critical level"),this.setStreamState(f.BUFFERING);break}if(this.playbackState===y.PAUSED){this.isBufferLevelSteady()||(this.debugMsg("--- switch to BUFFERING on pause"),this.setStreamState(f.BUFFERING));break}!this.segmentInProgress&&this.index.hasMoreSegments()&&this.getBufferLevel()-this.getSegmentTimeToArrival()<this.c.bufferLevelSteady&&(this.index.next(),this.debugMsg("--- segment "+this.index.getCurrentSegmentId()+" TTA="+this.getSegmentTimeToArrival()+"s"),this.fetchSegment(!0).then(e,t))}var r=this;i(function(){var e=r;e.scope.$$phase&&e.scope.$apply()},1.5*this.getSegmentTimeToArrival())},v.prototype.debugBufferState=function(e){if(this.haveIndex){var t=this.getBufferLevel(),i=this.getCurrentBitrate(),n=this.getCurrentBandwidth(),r=e||"";this.debugMsg(r+"["+this.engineId+"] [state:"+u(this.playbackState)+"/"+o(this.streamState)+" buf:"+t.toFixed(2)+"s, rate:"+i.toFixed(2)+"/"+n.toFixed(2)+"kbps, play:"+this.player.currentTime.toFixed(2)+"s, dur(src/idx):"+this.mediaSource.duration.toFixed(2)+"/"+this.index.getDuration().toFixed(2)+"s, seg (next/last):"+this.index.getCurrentSegmentId()+"/"+this.index.getActiveVariant().maxSegmentId+"]")}},v.prototype.debugEngineState=function(e){this.debugMsg(e+"["+this.engineId+"]  : NetState="+this.player.networkState+" ready="+this.player.readyState+" v_width="+this.player.videoWidth+" v_height="+this.player.videoHeight+" p_width="+this.player.width+" p_height="+this.player.height+" s_width="+screen.width+" s_height="+screen.height+" duration="+this.player.duration+" played="+(this.player.played.length?this.player.played.end(0):0)+" current="+(this.player.currentTime?this.player.currentTime:0)+" buffered="+(this.player.buffered.length?this.player.buffered.end(0):0)+" seek1="+(this.player.seekable.length?this.player.seekable.start(0):0)+" seek2="+(this.player.seekable.length?this.player.seekable.end(0):0))},v.prototype.errorMsg=function(){},v.prototype.debugMsg=function(){},{getInstance:function(){return new v}}}]),angular.module("tsunami.services").factory("HTML5VideoEngine",["$log","sound",function(e,t){var i=0,n=function(){this.engineId=i++,this.scope=null,this.videoObject=null,this.width=0,this.height=0,this.loading=!1,this.buffering=!1,this.seeking=!1,this.stalled=!1,this.haveMeta=!1,this.eos=!1,this.currentSrcUrl="",this.player=null};return n.prototype.init=function(e,t,i){if(this.hasHTML5VideoElementSupport()&&e&&t){this.player=e,this.scope=t,this.videoObject=i;var n=angular.element(e);n.bind("abort",angular.bind(this,this.abortHandler)),n.bind("canplay",angular.bind(this,this.canPlayHandler)),n.bind("canplaythrough",angular.bind(this,this.canPlayThroughHandler)),n.bind("durationchange",angular.bind(this,this.durationChangeHandler)),n.bind("emptied",angular.bind(this,this.emptiedHandler)),n.bind("ended",angular.bind(this,this.endedHandler)),n.bind("error",angular.bind(this,this.errorHandler)),n.bind("loadeddata",angular.bind(this,this.loadedDataHandler)),n.bind("loadedmetadata",angular.bind(this,this.loadedMetaDataHandler)),n.bind("loadstart",angular.bind(this,this.loadStartHandler)),n.bind("pause",angular.bind(this,this.pauseHandler)),n.bind("play",angular.bind(this,this.playHandler)),n.bind("playing",angular.bind(this,this.playingHandler)),n.bind("progress",angular.bind(this,this.progressHandler)),n.bind("ratechange",angular.bind(this,this.rateChangeHandler)),n.bind("seeked",angular.bind(this,this.seekedHandler)),n.bind("seeking",angular.bind(this,this.seekingHandler)),n.bind("stalled",angular.bind(this,this.stalledHandler)),n.bind("suspend",angular.bind(this,this.suspendHandler)),n.bind("timeupdate",angular.bind(this,this.timeupdateHandler)),n.bind("volumechange",angular.bind(this,this.volumeChangeHandler)),n.bind("waiting",angular.bind(this,this.waitingHandler))}},n.prototype.shutdown=function(){if(this.hasHTML5VideoElementSupport()&&angular.isElement(this.player)){var e=angular.element(this.player);e.unbind("abort"),e.unbind("canplay"),e.unbind("canplaythrough"),e.unbind("durationchange"),e.unbind("emptied"),e.unbind("ended"),e.unbind("error"),e.unbind("loadeddata"),e.unbind("loadedmetadata"),e.unbind("loadstart"),e.unbind("pause"),e.unbind("play"),e.unbind("playing"),e.unbind("progress"),e.unbind("ratechange"),e.unbind("seeked"),e.unbind("seeking"),e.unbind("stalled"),e.unbind("suspend"),e.unbind("timeupdate"),e.unbind("volumechange"),e.unbind("waiting"),this.player=null,this.scope=null,this.videoObject=null}},n.prototype.isSupported=function(){return this.hasHTML5VideoElementSupport()},n.prototype.scopeApply=function(){this.scope.$$phase||this.scope.$apply()},n.prototype.abortHandler=function(){this.buffering=!1,this.stalled=!1,this.loading=!1,this.scopeApply()},n.prototype.canPlayHandler=function(){this.buffering=!1,this.stalled=!1,this.scope.$emit("bufferupdate",this.videoObject,this.player.currentTime,this.getBuffered()),this.scopeApply()},n.prototype.canPlayThroughHandler=function(){this.buffering=!1,this.stalled=!1,this.scope.$emit("loaded",this.videoObject,this.getBuffered()),this.scopeApply()},n.prototype.durationChangeHandler=function(){this.stalled=!1,this.scope.$emit("timeupdate",this.videoObject,this.player.currentTime,this.getDuration()),this.scopeApply()},n.prototype.emptiedHandler=function(){this.buffering=!1,this.stalled=!1,this.scope.$emit("bufferupdate",this.videoObject,this.player.currentTime,this.getBuffered()),this.scopeApply()},n.prototype.endedHandler=function(){this.eos=!0,this.scope.$emit("eos",this.videoObject,this.getCurrentTime()),this.scopeApply()},n.prototype.errorHandler=function(){this.buffering=!1,this.stalled=!0,this.loading=!1,this.scope.$emit("error",this.videoObject,this.player.currentTime,this.player.error),this.scopeApply()},n.prototype.loadedDataHandler=function(){this.buffering=!1,this.stalled=!1,this.scopeApply()},n.prototype.loadedMetaDataHandler=function(){if(this.player.readyState>=1){if(this.currentSrcUrl=this.player.currentSrc,0===this.width||0===this.height){var e=this.getVideoWidth(),t=this.getVideoHeight(),i=t/e;this.setWidth(this.width||this.height/i||e),this.setHeight(this.height||this.width*i||t)}this.haveMeta=!0,this.loading=!1,this.scopeApply()}},n.prototype.loadStartHandler=function(){this.loading=!0,this.scopeApply()},n.prototype.playHandler=function(){this.scopeApply()},n.prototype.playingHandler=function(){this.scope.$emit("playing",this.videoObject,this.getCurrentTime()),this.scopeApply()},n.prototype.pauseHandler=function(){this.scope.$emit("paused",this.videoObject,this.getCurrentTime()),this.scopeApply()},n.prototype.progressHandler=function(){this.stalled=!1,this.scope.$emit("bufferupdate",this.videoObject,this.player.currentTime,this.getBuffered()),this.scopeApply()},n.prototype.rateChangeHandler=function(){},n.prototype.seekedHandler=function(){this.seeking=!1,this.buffering=!1,this.scope.$emit("seeked",this.videoObject,this.getCurrentTime()),this.scopeApply()},n.prototype.seekingHandler=function(){this.seeking=!0,this.buffering=!0,this.scopeApply()},n.prototype.stalledHandler=function(){this.stalled=!0,this.scopeApply()},n.prototype.suspendHandler=function(){this.stalled=!0,this.scopeApply()},n.prototype.timeupdateHandler=function(){this.scope.$emit("timeupdate",this.videoObject,this.player.currentTime,this.getDuration()),this.scopeApply()},n.prototype.volumeChangeHandler=function(){t.setVolume(this.player.volume),this.scope.$emit("volumeupdate",this.videoObject,this.player.volume),this.scopeApply()},n.prototype.waitingHandler=function(){this.scopeApply()},n.prototype.canPlaySource=function(e){var t=this.player.canPlayType(e);return"maybe"===t||"probably"===t?!0:!1},n.prototype.setSourceUrl=function(e){return""===this.getSourceUrl()||this.getSourceUrl()!==this.currentSrcUrl?(this.player.src=e,this.loading=!1,this.seeking=!1,this.haveMeta=!1,this.eos=!1,this.currentSrcUrl="",!0):!1},n.prototype.getSourceUrl=function(){return this.player.currentSrc},n.prototype.setPosterUrl=function(e){this.player.poster=e},n.prototype.getPosterUrl=function(){return this.player.poster},n.prototype.setWidth=function(e){this.width=e,this.player.width=e},n.prototype.getWidth=function(){return this.player.width},n.prototype.getVideoWidth=function(){return this.player.videoWidth},n.prototype.setHeight=function(e){this.height=e,this.player.height=e},n.prototype.getHeight=function(){return this.player.height},n.prototype.getVideoHeight=function(){return this.player.videoHeight},n.prototype.load=function(){this.player.load()},n.prototype.isLoading=function(){return this.loading},n.prototype.getNetworkState=function(){return this.player.networkState},n.prototype.getReadyState=function(){return this.player.readyState},n.prototype.play=function(){this.resetEnded(),this.player.play()},n.prototype.pause=function(){this.player.pause()},n.prototype.isPaused=function(){return this.player.paused},n.prototype.isPlaying=function(){return!this.player.paused},n.prototype.isEnded=function(){return this.eos},n.prototype.resetEnded=function(){this.eos=!1},n.prototype.isBuffering=function(){return this.buffering},n.prototype.isStalled=function(){return this.stalled},n.prototype.isSeekable=function(){return!0},n.prototype.isSeeking=function(){return this.seeking},n.prototype.initVolume=function(){this.player.volume=t.getVolume()},n.prototype.setVolume=function(e){this.player.volume=e},n.prototype.getVolume=function(){return this.player.volume},n.prototype.getBuffered=function(){for(var e=this.player.currentTime||0,t=this.player.buffered,i=angular.isDefined(t)?t.length:0,n=0;i>n;++n)if(e>=t.start(n)&&t.end(n)>=e)return t.end(n);return 0},n.prototype.getDuration=function(){return this.player.duration||0},n.prototype.getCurrentTime=function(){return this.player.currentTime||0},n.prototype.setCurrentTime=function(e){this.player.currentTime=e||0},n.prototype.getError=function(){return this.player.error},n.prototype.hasHTML5VideoElementSupport=function(){return!!document.createElement("video").canPlayType},{getInstance:function(){return new n}}}]),angular.module("tsunami.services").factory("M3U8Parser",["$log",function(e){function t(e){var t=5381;for(i=0;e.length>i;i++)t=(t<<5)+t+e.charCodeAt(i);return t}"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)==e});var n={FIXED:1,APPEND:2,SLIDING:3},r=function(){this.haveEXTM3UTag=!1,this.style=n.APPEND,this.type="",this.version=0,this.allowCache=!1,this.bandwidth=0,this.programId=0,this.resolution="",this.codecs="",this.mimeType="",this.mimeTypeWithCodec="",this.url="",this.baseUrl="",this.isIframeOnly=!1,this.haveMediaSequence=!1,this.sequenceStart=0,this.numSegments=0,this.minSegmentId=0,this.maxSegmentId=-1,this.targetDuration=0,this.indexedDuration=0,this.lastDuration=0,this.eos=!1,this.currentSegmentId=0,this.playlist=[]};r.prototype.getDuration=function(){return this.indexedDuration},r.prototype.getSegmentDuration=function(){return this.targetDuration},r.prototype.getSegmentIdFromTime=function(e){for(var t=this.playlist.length,i=0,n=0;t>n;n++)if(i+=this.playlist[n].duration,i>e)return n+this.minSegmentId;return this.maxSegmentId},r.prototype.seekTo=function(e){var t=this.getSegmentIdFromTime(e);return t>=0?(this.currentSegmentId=t,!0):!1},r.prototype.next=function(){return this.currentSegmentId<=this.maxSegmentId&&(this.currentSegmentId=Math.max(this.currentSegmentId+1,this.minSegmentId)),this.currentSegmentId},r.prototype.prev=function(){return this.currentSegmentId>this.minSegmentId&&this.currentSegmentId--,this.currentSegmentId},r.prototype.last=function(){this.currentSegmentId=this.maxSegmentId},r.prototype.hasMoreSegments=function(){return this.currentSegmentId<this.maxSegmentId},r.prototype.getCurrentSegmentId=function(){return this.currentSegmentId},r.prototype.getLastSegmentId=function(){return this.maxSegmentId},r.prototype.getCurrentPlaylistItem=function(){return this.playlist[this.currentSegmentId-this.minSegmentId]},r.prototype.forceEOS=function(){return this.eos=!0};var s=function(){this.id=0,this.duration=0,this.continuous=!0,this.keyMethod="",this.keyURI="",this.keyIV="",this.byteLen=0,this.byteOffs=0,this.valid_until=0,this.url=""},a=function(){this.hasChanged=!1,this.reload_at=0,this.checksum=0,this.hasVariants=!1,this.activeVariant=0,this.variants=[],this.version=0};a.prototype.getDuration=function(){return this.variants[this.activeVariant].getDuration()},a.prototype.getSegmentDuration=function(){return this.variants[this.activeVariant].getSegmentDuration()},a.prototype.getSegmentIdFromTime=function(e){return this.variants[this.activeVariant].getSegmentIdFromTime(e)},a.prototype.getActiveVariant=function(){return this.variants[this.activeVariant]},a.prototype.hasMoreSegments=function(){return this.variants[this.activeVariant].hasMoreSegments()},a.prototype.getCurrentSegmentId=function(){return this.variants[this.activeVariant].getCurrentSegmentId()},a.prototype.getLastSegmentId=function(){return this.variants[this.activeVariant].getLastSegmentId()},a.prototype.getCurrentPlaylistItem=function(){return this.variants[this.activeVariant].getCurrentPlaylistItem()},a.prototype.seekTo=function(e){return this.variants[this.activeVariant].seekTo(e)},a.prototype.next=function(){return this.variants[this.activeVariant].next()},a.prototype.prev=function(){return this.variants[this.activeVariant].prev()},a.prototype.last=function(){return this.variants[this.activeVariant].last()},a.prototype.getActiveVariantMimeType=function(){var e=this.getActiveVariant().mimeType;return""===e?"*/*":e},a.prototype.setActiveVariantMimeType=function(e){this.getActiveVariant().mimeType=e},a.prototype.getActiveVariantMimeTypeWithCodec=function(){var e=this.getActiveVariant().mimeTypeWithCodec;return""===e?"*/*":e},a.prototype.setActiveVariantMimeTypeWithCodec=function(e){this.getActiveVariant().mimeTypeWithCodec=e},r.prototype.forceEOS=function(){return this.getActiveVariant().forceEOS()};var o=function(){this.reset()};return o.prototype.reset=function(){this.idx=new a,this.lastidx=new a,this.lineCount=0,this.expectUrl=!1,this.stopParsing=!1,this.error="",this.isNextContinuous=!0,this.vID=0,this.pID=0,this.lastKeyMethod="",this.lastKeyURI="",this.lastKeyIV="",this.nextSegmentId=0},o.prototype.getIndex=function(){return this.idx},o.prototype.getError=function(){return this.error},o.prototype.init=function(e,t){this.lastidx=this.idx,this.idx=new a,this.idx.version=this.lastidx.version+1,this.idx.loaded_at=t,this.idx.activeVariant=this.lastidx.activeVariant,this.lineCount=0,this.expectUrl=!1,this.stopParsing=!1,this.error="",this.isNextContinuous=!0,this.vID=0,this.pID=0,this.lastKeyMethod="",this.lastKeyURI="",this.lastKeyIV="",this.nextSegmentId=0},o.prototype.parse=function(i,s,a){if(this.error="",angular.isUndefined(i)||angular.isUndefined(s)||angular.isUndefined(a)||""===i||""===s)return this.error="empty argument to parse",!1;var o=t(i);if(this.lastidx.checksum===o)return this.idx.hasChanged=!1,this.idx.reload_at=a+1e3*this.idx.getActiveVariant().targetDuration/2,e.info("HLS index did not change, reload at "+this.idx.reload_at+" fetched="+a),!0;this.init(s,a),this.idx.hasChanged=!0,this.idx.checksum=o,this.idx.variants.push(new r),this.vID=0;var u=this.idx.getActiveVariant();return this.lastidx.hasVariants&&(u.codecs=this.lastidx.getActiveVariant().codecs||"",u.mimeType=this.lastidx.getActiveVariant().mimeType||"",u.mimeTypeWithCodec=this.lastidx.getActiveVariant().mimeTypeWithCodec||""),u.url=s,u.baseUrl=s.slice(0,s.lastIndexOf("/")),u.currentSegmentId=this.idx.version>1?this.lastidx.getActiveVariant().currentSegmentId:0,this.doParse(i)&&this.doCheck()?(this.idx.reload_at=u.eos?0:this.idx.loaded_at+1e3*u.lastDuration,u.style==n.SLIDING&&(u.currentSegmentId=Math.max(u.currentSegmentId,u.minSegmentId)),!0):(this.idx=this.lastidx,!1)},o.prototype.doParse=function(t){return angular.forEach(t.split("\n"),function(e,t){if(!this.stopParsing&&0!==e.length){switch(t>0&&!this.idx.variants[this.vID].haveEXTM3UTag&&(this.stopParsing=!0),!0){case e.startsWith("#EXTINF"):var i=+e.split(":")[1].split(",")[0],r=new s;r.id=this.nextSegmentId,r.duration=i,r.continuous=this.isNextContinuous,r.keyMethod=this.lastKeyMethod,r.keyURI=this.lastKeyURI,r.keyIV=this.lastKeyIV,r.byteLen=0,r.byteOffs=0,r.valid_until=0,r.url="",this.isNextContinuous=!0,this.expectUrl=!0,this.nextSegmentId++,this.idx.variants[this.vID].playlist[this.pID]=r,this.idx.variants[this.vID].numSegments++,this.idx.variants[this.vID].maxSegmentId++,this.idx.variants[this.vID].indexedDuration+=i,this.idx.variants[this.vID].lastDuration=i;break;case e.startsWith("#EXTM3U"):this.idx.variants[this.vID].haveEXTM3UTag=!0;break;case e.startsWith("#EXT-X-PLAYLIST-TYPE"):var a=angular.lowercase(e.split(":")[1]);switch(this.idx.variants[this.vID].type=a,a){case"vod":this.idx.variants[this.vID].style=n.FIXED;break;case"event":this.idx.variants[this.vID].style=n.APPEND;break;default:this.error="unsupported playlist type '"+a+"'",this.stopParsing=!0}break;case e.startsWith("#EXT-X-ALLOW-CACHE"):this.idx.variants[this.vID].allowCache="NO"!==e.split(":")[1];break;case e.startsWith("#EXT-X-TARGETDURATION"):this.idx.variants[this.vID].targetDuration>0&&(this.error="multiple TARGETDURATION tags",this.stopParsing=!0),this.idx.variants[this.vID].targetDuration=+e.split(":")[1];break;case e.startsWith("#EXT-X-VERSION"):this.idx.variants[this.vID].version>0&&(this.error="multiple VERSION tags",this.stopParsing=!0),this.idx.variants[this.vID].version=+e.split(":")[1];break;case e.startsWith("#EXT-X-MEDIA-SEQUENCE"):var o=+e.split(":")[1];this.idx.variants[this.vID].sequenceStart=o,this.idx.variants[this.vID].minSegmentId=o,this.idx.variants[this.vID].maxSegmentId=o-1,this.idx.variants[this.vID].haveMediaSequence=!0,this.nextSegmentId=this.idx.variants[this.vID].sequenceStart,this.idx.variants[this.vID].style!=n.FIXED&&this.idx.variants[this.vID].sequenceStart>0&&(this.idx.variants[this.vID].style=n.SLIDING);break;case e.startsWith("#EXT-X-ENDLIST"):this.idx.variants[this.vID].eos&&(this.error="multiple ENDLIST tags",this.stopParsing=!0),this.idx.variants[this.vID].eos=!0,this.idx.variants[this.vID].style=n.FIXED;break;case e.startsWith("#EXT-X-DISCONTINUITY"):this.isNextContinuous=!1;break;case e.startsWith("#EXT-X-MEDIA"):break;case e.startsWith("#EXT-X-PROGRAM-DATE-TIME"):break;case e.startsWith("#EXT-X-STREAM-INF"):break;case e.startsWith("#EXT-X-KEY"):this.lastKeyMethod="",this.lastKeyURI="",this.lastKeyIV="";break;case e.startsWith("#EXT-X-BYTERANGE"):break;case e.startsWith("#EXT-X-I-FRAMES-ONLY"):break;case e.startsWith("#EXT-X-I-FRAME-STREAM-INF"):break;case e.startsWith("#EXT-X-MAP"):break;case e.startsWith("#EXT"):this.error="unknown M3U8 tag in line '"+e+"'",this.stopParsing=!0;break;case e.startsWith("#"):break;default:if(this.expectUrl){var u;u=e.startsWith("http://")||e.startsWith("https://")?e:this.idx.variants[this.vID].baseUrl+"/"+e,this.idx.variants[this.vID].playlist[this.pID].url=u,this.pID++,this.expectUrl=!1}else this.error="unexpected non-tag line '"+e+"'",this.stopParsing=!0}this.lineCount++}},this),""!==this.error?(e.error("HLS M3U8 parse error: "+this.error+" on line "+this.lineCount),!1):!0},o.prototype.doCheck=function(){var t=this.idx.getActiveVariant(),i=this.lastidx.getActiveVariant(),n=!0;t.version>3?(n=!1,e.error("HLS M3U8 content error: unsupported version "+t.version)):1>t.version&&(t.version=1),""!==t.type&&"vod"!==t.type&&"event"!==t.type&&(e.error("HLS M3U8 content error: unsupported playlist type '"+t.type+"'"),n=!1),0===t.targetDuration&&(e.error("HLS M3U8 content error: target duration not present"),n=!1),angular.isDefined(i)&&this.idx.version>1&&t.targetDuration!==i.targetDuration&&(e.error("HLS M3U8 content error: target duration changed from "+i.targetDuration+" to "+t.targetDuration),n=!1),angular.isDefined(i)&&this.idx.version>1&&t.allowCache!==i.allowCache&&(e.error("HLS M3U8 content error: allow cache tag changed from "+i.allowCache+" to "+t.allowCache),n=!1);for(var r=this.idx.loaded_at+t.indexedDuration,s=0;t.numSegments>s;s++){var a=t.playlist[s];if(""===a.url&&(e.error("HLS M3U8 content error: empty URL in playlist item "+a.id),n=!1),angular.isDefined(i)&&a.id>=i.minSegmentId&&a.id<=i.maxSegmentId){var o=i.playlist[a.id-i.minSegmentId];(a.id!==o.id||a.url!==o.url)&&(e.error("HLS M3U8 content error: playlist item mismatch "+a.id+"!="+o.id),n=!1)}t.haveMediaSequence&&(this.idx.getActiveVariant().playlist[s].valid_until=r)}return n},{getInstance:function(){return new o}}}]),angular.module("tsunami.services").factory("PerformanceMonitor",["$log","$resource","$timeout",function(){var e=function(e,t){this.server=e,this.interval=t};return e.prototype.sendReport=function(){},{getInstance:function(){return new e}}}]),angular.module("tsunami.services").service("sound",["$window",function(e){var t=function(){try{return"localStorage"in e&&null!==e.localStorage
}catch(t){return!1}},i=function(){var e=t?localStorage.getItem("tsunamijs.volume"):1;return e?e:1},n=function(e){t&&e!==void 0&&e>=0&&1>=e&&localStorage.setItem("tsunamijs.volume",e)};return{getVolume:i,setVolume:n}}]),angular.module("tsunami.services").factory("ThumbnailLoader",["$log","$http","$timeout",function(){var e=function(){this.streams=[],this.grids=[]};return e.prototype.newStream=function(){},e.prototype.deleteStream=function(){},e.prototype.newGrid=function(){},e.prototype.deleteGrid=function(){},e.prototype.getDuration=function(){},e.prototype.isLive=function(){},e.prototype.isEOS=function(){},e.prototype.getSourceWidth=function(){},e.prototype.getSourceHeight=function(){},e.prototype.setTargetWidth=function(){},e.prototype.setTargetHeight=function(){},e.prototype.getTargetWidth=function(){},e.prototype.getTargetHeight=function(){},e.prototype.getImage=function(){},e.prototype.getUrl=function(){},e.prototype.getBGStyle_CSS3=function(){},{getInstance:function(){return new e}}}]),angular.module("tsunami.templates").run(["$templateCache",function(e){e.put("template/livethumbnail.html",'<div class="ts-thumbnail">  <div class="ts-thumb-title" ng-show="c.showtitle" ng-style="{\'width\': c.width + 10}">{{c.video.title}}</div>  <div class="ts-thumb" ng-class="{\'selected\': selected}" ng-click="mouseClicked()" ng-mousemove="skipTo($event)" ng-style="{\'width\': c.width, \'minWidth\': c.width}">    <div class="ts-thumb-img" ng-style="{\'width\': c.width, \'height\': c.height, \'backgroundImage\': \'url(\' + bgimageurl +\')\'}"></div>    <div class="ts-thumb-skimmer" ng-style="{\'width\': c.width}" ng-show="c.skimmable && isSkimming()" ng-mousemove="skipTo($event)">      <div class="ts-layer ts-thumb-bg"></div>      <div class="ts-layer ts-thumb-pos" ng-style="{\'width\': skimmerWidth + \'%\'}"></div>    </div>    <div class="ts-thumb-status" ng-show="c.showstate" ng-class="{\'live\': isLive(), \'skimming\': isSkimming(), \'playback\': isEOS(), \'paused\': isPaused()}">{{status}}</div>  </div></div>')}]),angular.module("tsunami.templates").run(["$templateCache",function(e){e.put("template/storyplayer.html",'<div class="ts-player {{c.theme}}" ng-class="{    \'is-fullwindow\': isFullwindow,    \'is-fullscreen\': isFullscreen,    \'is-loading\': isLoading() && !isError,    \'is-buffering\': isBuffering() && !isError,    \'is-mouseout\': !isMouseOver && c.autohide,    \'is-mouseover\': isMouseOver || !c.autohide,    \'is-paused\': !isPlaying() && !isError,    \'is-playing\': isPlaying(),    \'is-failed\': isError    }"  ng-style="getStoryStyle()"  ng-mouseover="isMouseOver=true"  ng-mouseout="isMouseOver=false">  <div class="ts-anim"    ng-repeat="trackId in trackIds"    ng-show="showTrack(trackId)"    ng-style="getLTMaskStyle(trackId)"    ng-class="{      \'running\': isPlaying(),      \'paused\':!isPlaying()    }" >    <div class="ts-anim" ng-style="getRBMaskStyle(trackId)">      <video class="ts-engine" preload="none" x-webkit-airplay="allow" tabindex="0"             ng-style="getEngineStyle(trackId)">      </video>    </div>  </div>  <div class="ts-ui" ng-click="playpause($event)">    <div class="ts-waiting" ng-show="isBuffering() && !isError">      <em/><em/><em/>    </div>    <button class="ts-btn bottom left trim" title="Trim" ng-click="toggleTrimmer()" ng-show="c.enableTrimmer && !isError" ng-class="{show: showTrimmer}"></button>    <button class="ts-btn right top" title="Fullscreen" ng-class="{\'fsenter\': !isFullscreen && !isFullwindow, \'fsexit\': isFullscreen || isFullwindow}" ng-show="c.enableFullscreen && !isLoading() && !isError" ng-click="toggleFullscreen($event)"></button>    <button class="ts-btn right bottom stash" title="Stash" ng-show="c.enableStashing && stashable && !isLoading() && !isError" ng-click="stash()"></button>    <div class="ts-controls" ng-show="!isLoading() && !isError">      <div class="ts-timeline" ng-click="seek($event)">        <div class="ts-buffered" ng-style="{\'width\': buffered + \'%\'}"></div>        <div class="ts-played" ng-style="{\'width\': played + \'%\'}"></div>      </div>    </div>    <div class="ts-time" ng-show="!isLoading() && !isError">      <em class="ts-elapsed">{{currentTime/1000 | timecode}}</em>      <em class="ts-duration">{{duration/1000 | timecode}}</em>    </div>    <div class="ts-errorbox" ng-show="isError">      <div class="ts-errormsg">{{errorMsg}}</div>    </div>  </div></div>')}]),angular.module("tsunami.templates").run(["$templateCache",function(e){e.put("template/trimmer.html",'<div class="ts-trimmer">  <div class="ts-trimline" ng-click="eatClick($event)">    <div class="ts-trimlayer ts-trimnails">      <div ng-repeat="t in thumbs" class="ts-trimnail" ng-style="makeThumbStyle(t, thumbs.length)"></div>    </div>    <div class="ts-trimlayer ts-trimlmask" ng-style="{      \'width\': (leftMarker * 100 + 0.5).toFixed(2).toString() + \'%\'    }"></div>    <div class="ts-trimlayer ts-trimrmask" ng-style="{      \'width\': ((1.0 - rightMarker) * 100 + 0.1).toFixed(2).toString() + \'%\',      \'left\': (rightMarker * 100).toFixed(2).toString() + \'%\'    }"></div>    <div class="ts-trimlayer ts-trimbox" ng-style="{      \'left\': (leftMarker * 100).toFixed(2).toString() + \'%\',      \'width\': ((rightMarker - leftMarker) * 100 + 0.1).toFixed(2).toString() + \'%\'    }">        <div class="ts-trimlhandle">            <div class="ts-trimgrip"></div>            <div class="ts-trimgrip"></div>        </div>        <div class="ts-trimrhandle">            <div class="ts-trimgrip"></div>            <div class="ts-trimgrip"></div>        </div>        <div class="ts-trimselect"></div>    </div>  </div></div>')}]),angular.module("tsunami.templates").run(["$templateCache",function(e){e.put("template/videoplayer.html",'<div class="ts-player {{c.theme}}" ng-class="{    \'is-fullwindow\': isFullwindow,    \'is-fullscreen\': isFullscreen,    \'is-loading\': isLoading() && !isError,    \'is-buffering\': isBuffering() && !isError,    \'is-mouseout\': !isMouseOver && c.autohide,    \'is-mouseover\': isMouseOver || !c.autohide,    \'is-paused\': !isPlaying() && !isError,    \'is-playing\': isPlaying(),    \'is-failed\': isError    }"  ng-style="{    \'width\': playerWidth,    \'height\': playerHeight  }"  ng-mouseover="isMouseOver=true"  ng-mouseout="isMouseOver=false">  <video class="ts-engine" preload="none" x-webkit-airplay="allow" tabindex="0" ></video>  <div class="ts-ui" ng-click="playpause($event)">    <div class="ts-waiting" ng-show="isBuffering() && !isError">      <em/><em/><em/>    </div>    <div ng-show="showTrimmer && !isError">      <div trimmer config="{       showTitle: false,       showPlayhead: false,       thumbSource: c.thumbsource,       thumbUrl: c.video.thumbnailUrl,       thumbWidth: 160,       thumbHeight: 90,       thumbGridx: c.gridx,       thumbGridy: c.gridy,       videoId: c.video.id,       videoTitle: c.video.title,       videoDuration: c.video.duration,       trimIn: 0.0,       trimOut: c.video.duration      }"></div>    </div>    <button class="ts-btn top left live" title="Live" ng-class="{active: isPlayingLive()}" ng-show="c.enableLive && isLive() && !isError" ng-click="seekLive($event)">Live</button>    <button class="ts-btn bottom left trim" title="Trim" ng-click="toggleTrimmer($event)" ng-show="c.enableTrimmer && !isError"></button>    <button class="ts-btn right top" title="Fullscreen" ng-class="{\'fsenter\': !isFullscreen && !isFullwindow, \'fsexit\': isFullscreen || isFullwindow}" ng-show="c.enableFullscreen && !isError" ng-click="toggleFS($event)"></button>    <div class="ts-volume bottom right" ng-show="c.showVolume && !isError"      ng-mousemove="hoverVolume($event)"      ng-mousedown="startSetVolume($event)"      ng-mouseup="stopSetVolume($event)"      ng-mouseout="hoverPos=0">      <div class="ts-volumebar" style="left:0"        ng-class="{\'highlight\': hoverPos > volumeStops[0]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[0]}"></div>      </div>      <div class="ts-volumebar" style="left:5px" ng-class="{\'highlight\': hoverPos > volumeStops[1]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[1]}"></div>      </div>      <div class="ts-volumebar" style="left:10px" ng-class="{\'highlight\': hoverPos > volumeStops[2]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[2]}"></div>      </div>      <div class="ts-volumebar" style="left:15px" ng-class="{\'highlight\': hoverPos > volumeStops[3]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[3]}"></div>      </div>      <div class="ts-volumebar" style="left:20px" ng-class="{\'highlight\': hoverPos > volumeStops[4]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[4]}"></div>      </div>      <div class="ts-volumebar" style="left:25px" ng-class="{\'highlight\': hoverPos > volumeStops[5]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[5]}"></div>      </div>      <div class="ts-volumebar" style="left:30px" ng-class="{\'highlight\': hoverPos > volumeStops[6]}" ng-mouseover="kickBar($event)">        <div class="ts-volumefill" ng-style="{\'width\': volumeFill[6]}"></div>      </div>    </div>    <button class="ts-btn right bottom stash" title="Stash" ng-show="c.enableStashing && stashable && !isError" ng-click="stash()"></button>    <div class="ts-controls" ng-show="!isLoading() && !isError">      <div class="ts-timeline" ng-click="seekTo($event)">        <div class="ts-buffered" ng-style="{\'width\': buffered + \'%\'}"></div>        <div class="ts-played" ng-style="{\'width\': played + \'%\'}"></div>      </div>    </div>    <div class="ts-time" ng-show="!isLoading() && !isError">      <em class="ts-elapsed">{{currentTime | timecode}}</em>      <em class="ts-duration">{{duration | timecode}}</em>    </div>    <div class="ts-errorbox" ng-show="isError">      <div class="ts-errormsg">{{errorMsg}}</div>    </div>    </div>  </div></div>')}]),angular.module("tsunami.templates").run(["$templateCache",function(e){e.put("template/videothumbnail.html",'<div class="ts-thumbnail">  <div class="ts-thumb-title" ng-show="c.showtitle" ng-style="{\'width\': c.width + 10}">{{video.title}}</div>  <div class="ts-thumb" ng-class="{\'selected\': selected}" ng-click="mouseClicked()"ng-style="{\'width\': c.width, \'minWidth\': c.width}">    <div class="ts-thumb-img" ng-mouseover="startPlay()" ng-mouseout="stopPlay()" ng-mousemove="skipTo_Thumb($event)" ng-class="{\'interact\': c.selectable && c.skimmable}" ng-style="{\'width\': c.width, \'height\': c.height, \'backgroundImage\': \'url(\' + thumburl +\')\'}"></div>    <div class="ts-thumb-skimmer" ng-style="{\'width\': c.width}" ng-show="c.skimmable && !c.showwave" ng-mousemove="skipTo($event)">      <div class="ts-layer ts-thumb-bg"></div>      <div class="ts-layer ts-thumb-pos" ng-style="{\'width\': skimmerWidth + \'%\'}"></div>    </div>    <div class="ts-thumb-wave" ng-show="c.showwave" ng-style="{\'width\': c.width}" ng-mousemove="skipTo($event)" ng-class="{\'interact\': c.selectable && c.skimmable}">      <div class="ts-layer ts-thumb-wavebg"></div>      <div class="ts-layer ts-thumb-wavepos" ng-style="{\'width\': skimmerWidth + \'%\'}"></div>      <div class="ts-layer ts-thumb-waveimg" ng-style="{\'backgroundImage\': \'url(\'+waveurl+\')\'}"></div>      <div class="ts-layer ts-highlight"></div>    </div>  </div>  <div class="ts-thumb-meta" ng-show="c.showmeta" ng-style="{\'width\': c.width + 10}">     <div class="ts-thumb-dur">{{video.duration | timecode}}</div>     <div class="ts-thumb-fps">{{video.framerate}}</div>     <div class="ts-thumb-res">{{video.resolution}}</div>  </div></div>')}]);